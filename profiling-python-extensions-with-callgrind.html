<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="Pelican" name="generator"/>
<meta content="Will Ayd Blog Posts" name="description"/>
<title>Profiling Python Extensions with callgrind</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" rel="stylesheet"/>
<link href="http://127.0.0.1:8000/theme/css/main.css" rel="stylesheet" type="text/css"/>
<link href="http://127.0.0.1:8000/theme/css/pygment.css" rel="stylesheet" type="text/css"/>
<link href="http://127.0.0.1:8000/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="http://127.0.0.1:8000/theme/css/stork.css" rel="stylesheet"/>
<link href="http://127.0.0.1:8000/theme/css/stork-dark.css" media="screen and (prefers-color-scheme: dark)" rel="stylesheet"/>
<link href="http://127.0.0.1:8000/css/custom.css" rel="stylesheet"/>
<link href="http://127.0.0.1:8000/feeds/all.atom.xml" rel="alternate" title="Will Ayd Atom Feed" type="application/atom+xml">
</link><link href="http://127.0.0.1:8000/profiling-python-extensions-with-callgrind.html" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Will Ayd", "item": "http://127.0.0.1:8000"}, {"@type": "ListItem", "position": 2, "name": "Profiling python extensions with callgrind", "item": "http://127.0.0.1:8000/profiling-python-extensions-with-callgrind.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Will Ayd"}, "publisher": {"@type": "Organization", "name": "Will Ayd"}, "headline": "Profiling Python Extensions with callgrind", "about": "profiling", "datePublished": "2023-04-03 00:00", "image": "https://willayd.com/images/og_logo.png"}</script><meta content="summary" name="twitter:card"/><meta content="http://127.0.0.1:8000/profiling-python-extensions-with-callgrind.html" property="og:url"/><meta content="article" property="og:type"/><meta content="Profiling Python Extensions with callgrind" property="og:title"/><meta content="This article shows you how to use callgrind to measure the execution of your Python extensions, which is critical for building high performance libraries." property="og:description"/><meta content="https://willayd.com/images/og_logo.png" property="og:image"/><meta content="en_US" property="og:locale"/></head>
<body class="min-h-screen flex flex-col max-w-7xl lg:max-w-none text-zinc-800 bg-neutral-100 dark:bg-neutral-900 dark:text-zinc-300 container mx-auto justify-center md:px-3">
<script>
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia(
                '(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
<nav class="sm:flex sm:justify-between xl:ml-32 pl-4 items-center">
<div class="flex pt-4">
<h2 class="font-semibold text-2xl"><a href="http://127.0.0.1:8000/">Will Ayd</a></h2>
<button aria-label="Light|Dark" class="text-zinc-700 dark:text-zinc-400 rounded-full focus:outline-none text-sm ml-2 p-1" id="theme-toggle" type="button">
<svg class="w-5 h-5 hidden" fill="currentColor" id="theme-toggle-dark-icon" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
<path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
</svg>
<svg class="w-5 h-5 hidden" fill="currentColor" id="theme-toggle-light-icon" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd"></path>
</svg>
</button>
</div>
<ul class="flex flex-wrap lg:mr-24 md:pt-0">
<li class="mr-4 pt-6"><a href="http://127.0.0.1:8000/archives.html">Archive</a></li>
<li class="mr-4 pt-6"><a href="http://127.0.0.1:8000/categories.html">Categories</a></li>
<li class="mr-4 pt-6"><a href="http://127.0.0.1:8000/tags.html">Tags</a></li>
<li class="mr-4 pt-6"><a href="http://127.0.0.1:8000/search.html">Search</a></li>
</ul>
</nav>
<div class="flex-grow md:max-w-screen-md md:mx-auto md:w-3/4 px-4">
<nav aria-label="Breadcrumb" class="text-zinc-800 dark:text-zinc-300 mt-12 pb-2 md:mt-16">
<ul class="p-0 inline-flex items-center">
<li class="flex items-center">
<a class="text-zinc-800 dark:text-zinc-300 inline-flex items-center" href="http://127.0.0.1:8000/">
<svg class="w-5 h-5 mr-2" fill="currentColor" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
<path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z">
</path>
</svg>
                        Home
                    </a>
<svg class="fill-current w-3 h-3 mr-2 ml-1" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg">
<path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path>
</svg>
</li>
<li class="flex items-center">
<a href="http://127.0.0.1:8000/categories.html">Categories</a>
<svg class="fill-current w-3 h-3 mr-2 ml-1" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg">
<path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path>
</svg>
</li>
<li class="flex items-center">
<a href="http://127.0.0.1:8000/category/profiling.html">profiling</a>
<svg class="fill-current w-3 h-3 mr-2 ml-1" viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg">
<path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path>
</svg>
</li>
</ul>
</nav>
<main>
<header>
<h1 class="font-semibold text-3xl my-2">Profiling Python Extensions with callgrind</h1>
<footer class="flex text-sm text-zinc-800 dark:text-zinc-400">
<div class="flex text-xs text-zinc-800 dark:text-zinc-400">
<time>April 03, 2023</time>
<div>
<span> · 9 min read</span>
</div>
<div>
<span> · Will Ayd</span>
</div>
</div>
</footer>
</header>
<details class="flex flex-col my-6 p-4 bg-zinc-200 dark:bg-zinc-800 rounded-lg">
<summary class="text-lg font-bold">Table of contents</summary>
<div class="mx-4 px-4 underline">
<div id="toc"><ul><li><a class="toc-href" href="#setting-up-our-environment-data" title="Setting up our environment / data">Setting up our environment / data</a></li><li><a class="toc-href" href="#building-pandas-for-use-with-callgrind" title="Building pandas for use with callgrind">Building pandas for use with callgrind</a></li><li><a class="toc-href" href="#timing-read_csv-with-callgrind" title="Timing read_csv with callgrind">Timing read_csv with callgrind</a></li><li><a class="toc-href" href="#where-to-go-from-here" title="Where to go from here">Where to go from here</a></li></ul></div>
</div>
</details>
<div class="max-w-7xl container mx-auto my-8 text-zinc-800 dark:text-zinc-300 prose lg:max-w-none prose-headings:text-zinc-800 prose-headings:dark:text-zinc-300 prose-h1:text-3xl lg:prose-h1:text-3xl prose-headings:font-semibold prose-pre:bg-zinc-200 prose-pre:text-zinc-800 dark:prose-pre:bg-zinc-800 dark:prose-pre:text-zinc-200 prose-blockquote:text-zinc-800 dark:prose-blockquote:text-zinc-200 prose-a:text-slate-600 prose-a:font-normal dark:prose-a:text-slate-400 dark:prose-strong:text-zinc-200 dark:prose-code:text-zinc-200 dark:prose-code:bg-zinc-800 prose-code:bg-zinc-200 prose-code:font-light prose-img:rounded-md sm:text-left md:text-justify">
<p>At some point in the development of a high performance Python library, you will likely find yourself writing C/C++ extensions (whether by hand or via <a class="reference external" href="https://cython.org/">Cython</a>). That alone may achieve the performance you desire, but in cases where you <em>still</em> need more what do you do? The Python runtime won't be able to track the performance details of any lower-level extensions, so many of the great tools used for Python profiling are out of the question. Instead we need to opt for profiling tools that directly target C/C++ executables.</p>
<p>There are many tools to help with this, but for this article we are going to use <a class="reference external" href="https://valgrind.org/docs/manual/cl-manual.html">callgrind</a>, which is part of the larger <a class="reference external" href="https://valgrind.org/">Valgrind</a> framework. As a profiling target we are going to pick the 1.5 release of the <a class="reference external" href="https://pandas.pydata.org/">pandas</a> library, where we are curious to know which parts of the <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_csv.html">read_csv</a> implementation may be a bottleneck.</p>
<div class="section" id="setting-up-our-environment-data">
<h2 id="setting-up-our-environment-data">Setting up our environment / data</h2>
<p>To simplify the setup I have created a Dockerfile custom-built for this article, which you can pull via <tt class="docutils literal">docker pull <span class="pre">willayd/blog-posts:pandas-callgrind</span></tt>. If not using Docker you will need to <a class="reference external" href="https://valgrind.org/docs/manual/manual-core.html#manual-core.install">install Valgrind</a> alongside all of the pandas build requirements <a class="reference external" href="https://pandas.pydata.org/pandas-docs/version/1.5/development/contributing_environment.html">from the 1.5.x release</a>.</p>
<p>You will also want to get a copy of the pandas 1.5 source code local to your computer. For this article we assume that source code will exist in a local directory named <cite>~/code/pandas-1.5</cite>. We will also checkout a particular commit to prevent any future changes made to 1.5.x from rendering the solution in this article incompatible.</p>
<div class="highlight"><pre><span></span>willayd@willayd:~$ mkdir -p ~/code
willayd@willayd:~$ git clone --depth<span class="o">=</span><span class="m">1</span> -b <span class="m">1</span>.5.x https://github.com/pandas-dev/pandas.git ~/code/pandas-1.5
willayd@willayd:~$ <span class="nb">cd</span> ~/code/pandas-1.5
willayd@willayd:~$ git checkout 778ab82
</pre></div>
<p>For data we can use the US Census <a class="reference external" href="https://www.census.gov/data/datasets/2020/econ/susb/2020-susb.html">2020 SUSB Annual Datasets by Establishment Industry</a> file, which contains this <a class="reference external" href="https://www2.census.gov/programs-surveys/susb/datasets/2020/us_state_6digitnaics_2020.txt">raw data</a>. Save the raw data to a file name <cite>us_state_6digitnaics_2020.txt</cite> located in <cite>~/code/pandas-1.5</cite>.</p>
<p>At this point we have data and the supporting files we need. If using docker, start up your container with <tt class="docutils literal">docker run <span class="pre">--rm</span> <span class="pre">-it</span> <span class="pre">-v</span> <span class="pre">${HOME}/code/pandas-1.5:/data</span> <span class="pre">-w</span> /data <span class="pre">willayd/blog-posts:pandas-callgrind</span></tt>.</p>
</div>
<div class="section" id="building-pandas-for-use-with-callgrind">
<h2 id="building-pandas-for-use-with-callgrind">Building pandas for use with callgrind</h2>
<p>In the simplest of use cases, we can follow the <a class="reference external" href="https://pandas.pydata.org/pandas-docs/version/1.5/development/contributing_environment.html">standard pandas instructions</a> for building the library and run it via callgrind to get a high level summary of which <em>functions</em> are taking the most time. However, we can do better and get <em>line-level</em> profiling if we compile our C extensions with debugging symbols.</p>
<p>If you worked through my previous article on <a class="reference external" href="http://127.0.0.1:8000/fundamental-python-debugging-part-1-python.html">debugging Python extensions</a> you would have seen us do this directly via gcc by passing the <cite>-g3</cite> flag. In our current use case with the pandas code base, we follow their documented instructions for <a class="reference external" href="https://pandas.pydata.org/pandas-docs/version/1.5/development/debugging_extensions.html">debugging C extensions in pandas</a> and instead use a <cite>--with-debugging-symbols</cite> flag. Both ultimately get us to the same place.</p>
<div class="highlight"><pre><span></span>root@90e75e54ee98:/data# python3 setup.py clean --all
root@90e75e54ee98:/data# python3 setup.py build_ext --inplace -j4 --with-debugging-symbols
Compiling pandas/_libs/algos.pyx because it changed.
Compiling pandas/_libs/arrays.pyx because it changed.
...
copying build/lib.linux-x86_64-cpython-310-pydebug/pandas/_libs/writers.cpython-310d-x86_64-linux-gnu.so -&gt; pandas/_libs
copying build/lib.linux-x86_64-cpython-310-pydebug/pandas/io/sas/_sas.cpython-310d-x86_64-linux-gnu.so -&gt; pandas/io/sas
copying build/lib.linux-x86_64-cpython-310-pydebug/pandas/_libs/json.cpython-310d-x86_64-linux-gnu.so -&gt; pandas/_libs
root@90e75e54ee98:/data#
</pre></div>
<p>Your build should have completed without error. If you run into any issues with the compilation you can try reducing the parallel compilation by removing the <cite>-j4</cite> flag; this will make your build take longer but should be stable (see <a class="reference external" href="https://github.com/pandas-dev/pandas/issues/47305">issue #47305</a> for background information).</p>
</div>
<div class="section" id="timing-read-csv-with-callgrind">
<h2 id="timing-read_csv-with-callgrind">Timing read_csv with callgrind</h2>
<p>With the build out of the way, we can now run our program under callgrind. To do this execute <tt class="docutils literal">valgrind <span class="pre">--tool=callgrind</span> <span class="pre">--callgrind-out-file=callgrind.out</span> python3 <span class="pre">-c</span> "import pandas as pd; <span class="pre">pd.read_csv('us_state_6digitnaics_2020.txt',</span> <span class="pre">encoding='cp1252')"</span></tt>. This one command runs our read_csv call while being traced by callgrind, and writes the results of the trace to <cite>callground.out</cite> for us. Note that this adds some call overhead, so expect execution to be slower than normal.</p>
<p>By default the output from callgrind is not very readable. Interested readers can peruse the <a class="reference external" href="https://valgrind.org/docs/manual/cl-format.html">Callgrind Format Specification</a> for a deeper understanding, but for this article we will use the <cite>callgrind_annotate</cite> command to inspect the output. This writes to stdout by default, so let's run it to a pager like <cite>less</cite> via <tt class="docutils literal">callgrind_annotate callgrind.out | less</tt>. The contents should look as follows:</p>
<div class="highlight"><pre><span></span>--------------------------------------------------------------------------------
Profile data file <span class="s1">'callgrind.out'</span> <span class="o">(</span>creator: callgrind-3.18.1<span class="o">)</span>
--------------------------------------------------------------------------------
I1 cache:
D1 cache:
LL cache:
Timerange: Basic block <span class="m">0</span> - <span class="m">3894679122</span>
Trigger: Program termination
Profiled target:  python3 -c import pandas as pd<span class="p">;</span> pd.read_csv<span class="o">(</span><span class="s1">'us_state_6digitnaics_2020.txt'</span>, <span class="nv">encoding</span><span class="o">=</span><span class="s1">'cp1252'</span><span class="o">)</span> <span class="o">(</span>PID <span class="m">439</span>, part <span class="m">1</span><span class="o">)</span>
Events recorded:  Ir
Events shown:     Ir
Event sort order: Ir
Thresholds:       <span class="m">99</span>
Include dirs:
User annotated:
Auto-annotation:  on

--------------------------------------------------------------------------------
Ir
--------------------------------------------------------------------------------
<span class="m">14</span>,377,625,638 <span class="o">(</span><span class="m">100</span>.0%<span class="o">)</span>  PROGRAM TOTALS

--------------------------------------------------------------------------------
Ir                      file:function
--------------------------------------------------------------------------------
<span class="m">3</span>,070,417,258 <span class="o">(</span><span class="m">21</span>.36%<span class="o">)</span>  pandas/_libs/src/parser/tokenizer.c:tokenize_bytes <span class="o">[</span>/data/pandas/_libs/parsers.cpython-310d-x86_64-linux-gnu.so<span class="o">]</span>
<span class="m">1</span>,156,873,554 <span class="o">(</span> <span class="m">8</span>.05%<span class="o">)</span>  /clones/cpython/Objects/unicodeobject.c:_PyUnicode_CheckConsistency <span class="o">[</span>/usr/local/bin/python3.10<span class="o">]</span>
<span class="m">1</span>,138,167,522 <span class="o">(</span> <span class="m">7</span>.92%<span class="o">)</span>  ./string/../sysdeps/x86_64/multiarch/memset-vec-unaligned-erms.S:__memset_avx2_unaligned_erms <span class="o">[</span>/usr/lib/x86_64-linux-gnu/libc.so.6<span class="o">]</span>
  <span class="m">809</span>,119,661 <span class="o">(</span> <span class="m">5</span>.63%<span class="o">)</span>  /clones/cpython/Objects/unicodeobject.c:charmap_decode_string <span class="o">[</span>/usr/local/bin/python3.10<span class="o">]</span>
  <span class="m">578</span>,399,204 <span class="o">(</span> <span class="m">4</span>.02%<span class="o">)</span>  pandas/_libs/src/klib/khash.h:__ac_X31_hash_string <span class="o">[</span>/data/pandas/_libs/parsers.cpython-310d-x86_64-linux-gnu.so<span class="o">]</span>
  <span class="m">551</span>,577,239 <span class="o">(</span> <span class="m">3</span>.84%<span class="o">)</span>  pandas/_libs/src/parser/tokenizer.c:str_to_int64 <span class="o">[</span>/data/pandas/_libs/parsers.cpython-310d-x86_64-linux-gnu.so<span class="o">]</span>
  <span class="m">415</span>,452,456 <span class="o">(</span> <span class="m">2</span>.89%<span class="o">)</span>  pandas/_libs/src/parser/tokenizer.c:end_field <span class="o">[</span>/data/pandas/_libs/parsers.cpython-310d-x86_64-linux-gnu.so<span class="o">]</span>
  <span class="m">361</span>,558,111 <span class="o">(</span> <span class="m">2</span>.51%<span class="o">)</span>  pandas/_libs/parsers.c:__pyx_f_6pandas_5_libs_7parsers__string_box_utf8 <span class="o">[</span>/data/pandas/_libs/parsers.cpython-310d-x86_64-linux-gnu.so<span class="o">]</span>
  <span class="m">310</span>,112,056 <span class="o">(</span> <span class="m">2</span>.16%<span class="o">)</span>  /clones/cpython/Python/ceval.c:_PyEval_EvalFrameDefault<span class="err">'</span><span class="m">2</span> <span class="o">[</span>/usr/local/bin/python3.10<span class="o">]</span>
</pre></div>
<p>The first thing to note is the total number of <cite>Instructions Read (Ir)</cite> for the program, which comes out to 14,377,625,638 instructions. Towards the bottom of the above snippet we see the top three function calls are <cite>tokenize_bytes</cite>, <cite>_PyUnicode_CheckConsistency</cite>, and <cite>__memset_avx2_unaligned_arms</cite>. Those are listed at 3,070,417,258 then 1,156,873,554 then 1,138,167,522 instructions in total, respectively. The total instructions in the first column of each of these functions is followed by a relative percentage to the total Ir of the program.</p>
<p>The main function of interest to us will be the very first one, not only because it represents the largest amount of instructions, but also because it comes directly from our user code. The second function comes from <cite>_PyUnicode_CheckConsistency</cite> in the CPython standard library, and the third function comes from assembly code bundled with <a class="reference external" href="https://www.gnu.org/software/libc/">libc</a>. While we may learn something from diving further into those, we have less control to change them than our user code.</p>
<p>At this point we know <cite>tokenize_bytes</cite> is where we spend the most time, but if you look at the source code you will see that it is a pretty big function. So how do we know <em>where</em> within this function we are spending our time?</p>
<p>Since we compiled our application with debug symbols, callgrind fortunately gives us <em>line level</em> profiling information further down in the file. Assuming you paged the <cite>callgrind_annotate</cite> output to <cite>less</cite> in the above command, input <tt class="docutils literal">/tokenize_bytes</tt> and hit <tt class="docutils literal">n</tt> to page through search results until you find the annotated function.</p>
<div class="highlight"><pre><span></span>            .           int tokenize_bytes<span class="o">(</span>parser_t *self,
        <span class="m">1</span>,428 <span class="o">(</span> <span class="m">0</span>.00%<span class="o">)</span>                     size_t line_limit, uint64_t start_lines<span class="o">)</span> <span class="o">{</span>
            .               int64_t i<span class="p">;</span>
            .               uint64_t slen<span class="p">;</span>
            .               int should_skip<span class="p">;</span>
            .               char c<span class="p">;</span>
            .               char *stream<span class="p">;</span>
        <span class="m">1</span>,224 <span class="o">(</span> <span class="m">0</span>.00%<span class="o">)</span>      char *buf <span class="o">=</span> self-&gt;data + self-&gt;datapos<span class="p">;</span>
.
        <span class="m">1</span>,224 <span class="o">(</span> <span class="m">0</span>.00%<span class="o">)</span>      const char <span class="nv">lineterminator</span> <span class="o">=</span> <span class="o">(</span>self-&gt;lineterminator <span class="o">==</span> <span class="s1">'\0'</span><span class="o">)</span> ?
            .                       <span class="s1">'\n'</span> : self-&gt;lineterminator<span class="p">;</span>
            .
            .               // <span class="m">1000</span> is something that couldn<span class="s1">'t fit in "char"</span>
<span class="s1">            .               // thus comparing a char to it would always be "false"</span>
<span class="s1">        1,428 ( 0.00%)      const int carriage_symbol = (self-&gt;lineterminator == '</span><span class="se">\0</span><span class="s1">') ? '</span><span class="se">\r</span><span class="s1">' : 1000;</span>
<span class="s1">          612 ( 0.00%)      const int comment_symbol = (self-&gt;commentchar != '</span><span class="se">\0</span><span class="s1">') ?</span>
<span class="s1">          612 ( 0.00%)              self-&gt;commentchar : 1000;</span>
<span class="s1">          612 ( 0.00%)      const int escape_symbol = (self-&gt;escapechar != '</span><span class="se">\0</span><span class="err">'</span><span class="o">)</span> ?
          <span class="m">612</span> <span class="o">(</span> <span class="m">0</span>.00%<span class="o">)</span>              self-&gt;escapechar : <span class="m">1000</span><span class="p">;</span>
            .
        <span class="m">2</span>,652 <span class="o">(</span> <span class="m">0</span>.00%<span class="o">)</span>      <span class="k">if</span> <span class="o">(</span>make_stream_space<span class="o">(</span>self, self-&gt;datalen - self-&gt;datapos<span class="o">)</span> &lt; <span class="m">0</span><span class="o">)</span> <span class="o">{</span>
   <span class="m">19</span>,380,953 <span class="o">(</span> <span class="m">0</span>.13%<span class="o">)</span>  <span class="o">=</span>&gt; pandas/_libs/src/parser/tokenizer.c:make_stream_space <span class="o">(</span>204x<span class="o">)</span>
            .                   int64_t <span class="nv">bufsize</span> <span class="o">=</span> <span class="m">100</span><span class="p">;</span>
            .                   self-&gt;error_msg <span class="o">=</span> malloc<span class="o">(</span>bufsize<span class="o">)</span><span class="p">;</span>
            .                   snprintf<span class="o">(</span>self-&gt;error_msg, bufsize, <span class="s2">"out of memory"</span><span class="o">)</span><span class="p">;</span>
            .                   <span class="k">return</span> -1<span class="p">;</span>
            .               <span class="o">}</span>
            .
        <span class="m">1</span>,224 <span class="o">(</span> <span class="m">0</span>.00%<span class="o">)</span>      <span class="nv">stream</span> <span class="o">=</span> self-&gt;stream + self-&gt;stream_len<span class="p">;</span>
          <span class="m">612</span> <span class="o">(</span> <span class="m">0</span>.00%<span class="o">)</span>      <span class="nv">slen</span> <span class="o">=</span> self-&gt;stream_len<span class="p">;</span>
</pre></div>
<p>The above snippet shows that every line in our source file is being annotated, along with the count / total percentage of <cite>Instruction Read</cite> event counts. You can use the <tt class="docutils literal">f</tt> and <tt class="docutils literal">b</tt> shortcuts to move forward and backwards through this source code, looking for lines that could be optimized. Paging through the output you will things like:</p>
<div class="highlight"><pre><span></span><span class="m">610</span>,811,124 <span class="o">(</span> <span class="m">4</span>.25%<span class="o">)</span>          switch <span class="o">(</span>self-&gt;state<span class="o">)</span> <span class="o">{</span>
          .                       <span class="k">case</span> START_FIELD_IN_SKIP_LINE:
          .                           <span class="k">if</span> <span class="o">(</span>IS_TERMINATOR<span class="o">(</span>c<span class="o">))</span> <span class="o">{</span>
          .                               END_LINE<span class="o">()</span><span class="p">;</span>
</pre></div>
<p>and</p>
<div class="highlight"><pre><span></span>          .                               self-&gt;state <span class="o">=</span> ESCAPED_CHAR<span class="p">;</span>
<span class="m">445</span>,004,236 <span class="o">(</span> <span class="m">3</span>.10%<span class="o">)</span>                  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span>IS_DELIMITER<span class="o">(</span>c<span class="o">))</span> <span class="o">{</span>
          .                               // end of field - end of line not reached yet
<span class="m">104</span>,886,583 <span class="o">(</span> <span class="m">0</span>.73%<span class="o">)</span>                      END_FIELD<span class="o">()</span><span class="p">;</span>
<span class="m">536</span>,772,513 <span class="o">(</span> <span class="m">3</span>.73%<span class="o">)</span>  <span class="o">=</span>&gt; pandas/_libs/src/parser/tokenizer.c:end_field <span class="o">(</span><span class="m">6</span>,169,799x<span class="o">)</span>
</pre></div>
<p>These are indicators that the lines <tt class="docutils literal">switch <span class="pre">(self-&gt;state)</span> {</tt>, <tt class="docutils literal">{ else if (IS_DELIMITER(c)) {</tt>, and the expansion of the <tt class="docutils literal"><span class="pre">END_FIELD();</span></tt> macro (which inserts calls to <tt class="docutils literal">end_field</tt>) take up 4.25%, 3.10% and 3.73% of your application runtime. Much of this has to do with the fact that these functions are invoked very often, so while they may not be <em>slow</em> in a traditional sense, you as a developer may decide that you need to still find a faster way to implement these.</p>
</div>
<div class="section" id="where-to-go-from-here">
<h2 id="where-to-go-from-here">Where to go from here</h2>
<p>For those interested in a more visual representation of their profile than what <cite>callgrind_annotate</cite> can offer, the <a class="reference external" href="https://kcachegrind.github.io/html/Home.html">KCachegrind</a> tool may prove very useful. Here is what the profile we created above would look like when opened within that tool:</p>
<img alt="KCachegrind Visualization" src="http://127.0.0.1:8000/images/KCachegrind_output.jpg"/>
<p>In the real world you will also want to profile a few different input files. We only went over the single US Census source file in this article, but you may be surprised to see different file sizes and contents yield different bottlenecks within your application.</p>
<p>As a final note, this article showed you how to identify potential bottlenecks within your application, without offering a point of view on how to fix them. In a future article we will dive into using tools like <a class="reference external" href="https://godbolt.org/">godbolt</a> or <a class="reference external" href="https://sourceware.org/gdb/">gdb</a> to view the assembly generated by our functions, which would be helpful to understand at a low level and yield insights on optimizations we may be able to make.</p>
</div>
<!-- <div class="aspect-w-16 aspect-h-9 mx-auto"></div> CSS placeholder -->
</div>
<footer class="flex flex-col mt-10">
<ul class="flex flex-wrap">
<li class="bg-zinc-200 hover:bg-zinc-300 dark:hover:bg-zinc-800 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 mb-2 mr-2 px-3 py-1.5 rounded-md transition ease-in active:-translate-y-1 active:scale-110 duration-75">
<a href="http://127.0.0.1:8000/tag/c.html">c</a>
</li>
<li class="bg-zinc-200 hover:bg-zinc-300 dark:hover:bg-zinc-800 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 mb-2 mr-2 px-3 py-1.5 rounded-md transition ease-in active:-translate-y-1 active:scale-110 duration-75">
<a href="http://127.0.0.1:8000/tag/python.html">python</a>
</li>
</ul>
<div class="flex w-full my-2 bg-zinc-200 dark:bg-zinc-700 rounded-lg">
<div class="w-1/2 hover:bg-zinc-300 dark:hover:bg-zinc-800 rounded-l-lg">
<a class="flex flex-col pr-2" href="http://127.0.0.1:8000/fundamental-python-debugging-part-3-cython-extensions.html">
<div class="mx-4 py-2 text-left">
<p class="text-zinc-600 dark:text-zinc-300 text-sm">« PREV PAGE</p>
<p class="text-left py-1 hover:underline">Fundamental Python Debugging Part 3 - Cython Extensions</p>
</div>
</a>
</div>
<div class="w-1/2 hover:bg-zinc-300 dark:hover:bg-zinc-800 rounded-r-lg">
<a class="flex flex-col" href="http://127.0.0.1:8000/comparing-cython-to-rust-evaluating-python-extensions.html">
<div class="text-right mx-4 py-2">
<p class="text-zinc-600 dark:text-zinc-300 text-sm">NEXT PAGE »</p>
<p class="text-right py-1 hover:underline">Comparing Cython to Rust - Evaluating Python Extensions</p>
</div>
</a>
</div>
</div>
<div class="flex bg-zinc-200 dark:bg-zinc-700 py-2 rounded-lg justify-center space-x-2 text-xs">
<ul>
<li class="bg-gray-900 p-1 text-white rounded-md">
<a aria-label="share Features on twitter" href="https://twitter.com/intent/tweet/?text=Features&amp;url=http://127.0.0.1:8000/profiling-python-extensions-with-callgrind.html" rel="noopener noreferrer" target="_blank" title="twitter">
<i aria-hidden="true" class="fab fa-twitter fa-2x"></i>
</a>
</li>
</ul>
<ul>
<li class="bg-gray-900 p-1 text-white rounded-md">
<a aria-label="share Features on linkedin" href="https://www.linkedin.com/sharing/share-offsite/?url=http://127.0.0.1:8000/profiling-python-extensions-with-callgrind.html" rel="noopener noreferrer" target="_blank" title="linkedin">
<i aria-hidden="true" class="fab fa-linkedin fa-2x"></i>
</a>
</li>
</ul>
<ul>
<li class="bg-gray-900 p-1 text-white rounded-md">
<a aria-label="share Features on reddit" href="https://reddit.com/submit?url=http://127.0.0.1:8000/profiling-python-extensions-with-callgrind.html" rel="noopener noreferrer" target="_blank" title="reddit">
<i aria-hidden="true" class="fab fa-reddit fa-2x"></i>
</a>
</li>
</ul>
<ul>
<li class="bg-gray-900 p-1 text-white rounded-md">
<a aria-label="share Features on facebook" href="https://facebook.com/sharer/sharer.php?u=http://127.0.0.1:8000/profiling-python-extensions-with-callgrind.html" rel="noopener noreferrer" target="_blank" title="facebook">
<i aria-hidden="true" class="fab fa-facebook fa-2x"></i>
</a>
</li>
</ul>
<ul>
<li class="bg-gray-900 p-1 text-white rounded-md">
<a aria-label="share Features on whatsapp" href="https://api.whatsapp.com/send?text=Features - http://127.0.0.1:8000/profiling-python-extensions-with-callgrind.html" rel="noopener noreferrer" target="_blank" title="whatsapp">
<i aria-hidden="true" class="fab fa-whatsapp fa-2x"></i>
</a>
</li>
</ul>
<ul>
<li class="bg-gray-900 p-1 text-white rounded-md">
<a aria-label="share Features on telegram" href="https://telegram.me/share/url?text=Features&amp;url=http://127.0.0.1:8000/profiling-python-extensions-with-callgrind.html" rel="noopener noreferrer" target="_blank" title="telegram">
<i aria-hidden="true" class="fab fa-telegram fa-2x"></i>
</a>
</li>
</ul>
</div>
</footer>
<div>
</div>
</main>
</div>
<footer class="flex w-full text-xs justify-center mt-10 mb-6 text-zinc-600 dark:text-zinc-400">
<div class="px-4">
<span>©2022 • </span>Powered by
            <a class="underline" href="https://getpelican.com/">Pelican</a> &amp;
            <a class="underline" href="https://github.com/aleylara/Papyrus">Papyrus</a>
</div>
</footer>
<script>
        let themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        let themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia(
                '(prefers-color-scheme: dark)').matches)) {
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            themeToggleDarkIcon.classList.remove('hidden');
        }
        let themeToggleBtn = document.getElementById('theme-toggle');
        themeToggleBtn.addEventListener('click', function () {
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');
            if (localStorage.getItem('color-theme')) {
                if (localStorage.getItem('color-theme') === 'light') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                }
            } else {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }
        });
    </script>
</body>
</html>