<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="Will Ayd Blog Posts">
    <title>Fundamental Python Debugging Part 2 - Python Extensions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
    <link rel="stylesheet" type="text/css" href="http://127.0.0.1:8000/theme/css/main.css" />
    <link rel="stylesheet" type="text/css" href="http://127.0.0.1:8000/theme/css/pygment.css" />
    <link rel="shortcut icon" href="http://127.0.0.1:8000/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="http://127.0.0.1:8000/theme/css/stork.css">
    <link rel="stylesheet" media="screen and (prefers-color-scheme: dark)"
        href="http://127.0.0.1:8000/theme/css/stork-dark.css">
    <link
        href="http://127.0.0.1:8000/feeds/all.atom.xml"
        type="application/atom+xml" rel="alternate" title="Will Ayd Atom Feed" />
<meta name="description" content="This article shows you how to step into Python extensions using gdb. Many high performance libraries in Python use C/C++ extensions (either..." />
</head>

<body class="min-h-screen flex flex-col max-w-7xl lg:max-w-none text-zinc-800 bg-neutral-100 
    dark:bg-neutral-900 dark:text-zinc-300 container mx-auto justify-center md:px-3 ">
    <script>
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia(
                '(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <nav class="sm:flex sm:justify-between xl:ml-32 pl-4 items-center">
        <div class="flex pt-4">
            <h1 class="font-semibold text-2xl"><a href="http://127.0.0.1:8000/">Will Ayd</a></h1>
            <button id="theme-toggle" type="button" aria-label="Light|Dark"
                class="text-zinc-700 dark:text-zinc-400 rounded-full focus:outline-none text-sm ml-2 p-1">
                <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                </svg>
                <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                        fill-rule="evenodd" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        <ul class="flex flex-wrap lg:mr-24 md:pt-0">
            <li class="mr-4 pt-6"><a  href="http://127.0.0.1:8000/archives.html">Archive</a></li>
            <li class="mr-4 pt-6"><a                     href="http://127.0.0.1:8000/categories.html">Categories</a></li>
            <li class="mr-4 pt-6"><a  href="http://127.0.0.1:8000/tags.html">Tags</a></li>
            <li class="mr-4 pt-6"><a  href="http://127.0.0.1:8000/search.html">Search</a></li>
        </ul>
    </nav>
    <div class="flex-grow md:max-w-screen-md md:mx-auto md:w-3/4 px-4">
        <nav class="text-zinc-800 dark:text-zinc-300 mt-12 pb-2 md:mt-16" aria-label="Breadcrumb">
            <ul class="p-0 inline-flex items-center">
                <li class="flex items-center">
                    <a href="http://127.0.0.1:8000/" class="text-zinc-800 dark:text-zinc-300 inline-flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z">
                            </path>
                        </svg>
                        Home
                    </a>
                    <svg class="fill-current w-3 h-3 mr-2 ml-1" xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 320 512">
                        <path
                            d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z" />
                    </svg>
                </li>
                <li class="flex items-center">
                    <a href="http://127.0.0.1:8000/categories.html">Categories</a>
                    <svg class="fill-current w-3 h-3 mr-2 ml-1" xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 320 512">
                        <path
                            d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z" />
                    </svg>
                </li>
                <li class="flex items-center">
                    <a href="http://127.0.0.1:8000/category/debugging.html">debugging</a>
                    <svg class="fill-current w-3 h-3 mr-2 ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                        <path
                            d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z" />
                    </svg>
                </li>
            </ul>
        </nav>

<main>
  <header>
    <h1 class="font-semibold text-3xl my-2">Fundamental Python Debugging Part 2 - Python Extensions</h1>
    <footer class="flex text-sm text-zinc-800 dark:text-zinc-400">
      <div class="flex text-xs text-zinc-800 dark:text-zinc-400">
        <time>February 22, 2023</time>
        <div>
          <span>&nbsp;·&nbsp;46 min read</span>
        </div>
        <div>
          <span>&nbsp;·&nbsp;Will Ayd</span>
        </div>
      </div>
    </footer>
  </header>
  <details class="flex flex-col my-6 p-4 bg-zinc-200 dark:bg-zinc-800 rounded-lg">
    <summary class="text-lg font-bold">Table of contents</summary>
    <div class="mx-4 px-4 underline">
      <div id="toc"><ul><li><a class="toc-href" href="#setting-up-our-environment" title="Setting up our environment">Setting up our environment</a></li><li><a class="toc-href" href="#building-our-first-extension" title="Building our first extension">Building our first extension</a></li><li><a class="toc-href" href="#inspecting-things-with-gdb" title="Inspecting things with gdb">Inspecting things with gdb</a></li><li><a class="toc-href" href="#debugging-segmentation-faults" title="Debugging Segmentation Faults">Debugging Segmentation Faults</a></li><li><a class="toc-href" href="#debugging-python-c-data-exchange" title="Debugging Python-&gt;C data exchange">Debugging Python-&gt;C data exchange</a></li><li><a class="toc-href" href="#closing-thoughts" title="Closing Thoughts">Closing Thoughts</a></li></ul></div>
    </div>
  </details>
  <div class="max-w-7xl container mx-auto my-8 text-zinc-800 dark:text-zinc-300  
              prose lg:max-w-none prose-headings:text-zinc-800 prose-headings:dark:text-zinc-300 
              prose-h1:text-3xl lg:prose-h1:text-3xl prose-headings:font-semibold 
              prose-pre:bg-zinc-200 prose-pre:text-zinc-800
              dark:prose-pre:bg-zinc-800 dark:prose-pre:text-zinc-200
              prose-blockquote:text-zinc-800
              dark:prose-blockquote:text-zinc-200
              prose-a:text-slate-600 prose-a:font-normal
              dark:prose-a:text-slate-400
              dark:prose-strong:text-zinc-200 
              dark:prose-code:text-zinc-200
              dark:prose-code:bg-zinc-800
              prose-code:bg-zinc-200
              prose-code:font-light
              prose-img:rounded-md
              sm:text-left md:text-justify
              ">
    <p><a class="reference external" href="https://docs.python.org/3/extending/index.html">Python extensions</a> are a key component in making Python libraries <em>fast</em>. With an extension, you have the ability to write code in a lower-level language like C or C++ but still interact with that code via the Python runtime. Many high-performance scientific Python libraries use this type of architecture, whether through hand-writing a C/C++ extension(s) and/or generating them using a Python to C/C++ <em>transpiler</em> like <a class="reference external" href="https://cython.org/">Cython</a>.</p>
<p>This has tradeoffs for a library author. While Python is an interpreted language, extensions are typically written in languages that need to be compiled. Extensions also cannot be debugged with pdb. However, as you'll see in the following sections, pdb is heavily influenced by a lot of the tooling used for extension debugging, so if you worked through <a class="reference external" href="http://127.0.0.1:8000/fundamental-python-debugging-part-1-python.html">the first article in this debugging series</a> you should have a solid foundation to build off of.</p>
<div class="section" id="setting-up-our-environment">
<h2 id="setting-up-our-environment">Setting up our environment</h2>
<p>A challenge we didn't face in the previous article was cross-platform tooling. pdb works regardless of your OS and architecture, but as we move further down into the stack we have to use tools more tailored to our environment.</p>
<p>Writing installation and usage instructions for all platforms would be quite the task. To abstract all of the nuances and make following through this guide easier, this guide assumes you will be using the docker image hosted at <a class="reference external" href="https://hub.docker.com/r/willayd/cpython-debugging">willayd/cpython-debugging</a>. This docker image contains the following items:</p>
<blockquote>
<ul class="simple">
<li><a class="reference external" href="https://gcc.gnu.org/">gcc</a>, which we use to build extensions</li>
<li><a class="reference external" href="https://github.com/python/cpython">CPython</a> source code located in <cite>/clones/cpython</cite></li>
<li>A development build of Python pre-installed</li>
<li>A custom build of <tt class="docutils literal">gdb</tt> which knows about the development Python installation</li>
</ul>
</blockquote>
<p>Not all of these elements are required, but they all make debugging easier.</p>
<p>To get started with the image, be sure to first install the <a class="reference external" href="https://docs.docker.com/engine/install">docker engine</a>, at which point you can then:</p>
<div class="highlight"><pre><span></span>docker<span class="w"> </span>pull<span class="w"> </span>willayd/cpython-debugging
</pre></div>
<p>A quick <tt class="docutils literal">docker image</tt> should show that same image on your local machine. Once you have the image installed, you will want to choose a location on your host computer to mount into the container you will run based off of that image, so something like:</p>
<div class="highlight"><pre><span></span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-it<span class="w"> </span>-w<span class="w"> </span>/data<span class="w"> </span>-v<span class="w"> </span>&lt;PATH_TO_YOUR_WORK&gt;:/data<span class="w"> </span>willayd/cpython-debugging
</pre></div>
<p>The <tt class="docutils literal"><span class="pre">-v</span></tt> flag here maps the part of its argument preceding the <tt class="docutils literal">:</tt> and locates it on your host computer. It then mounts that location from your host computer to the path specified after the <tt class="docutils literal">:</tt> within the container, which we've chosen above as <tt class="docutils literal">/data</tt>. Note that you can use shell expansion of environment variables like <tt class="docutils literal"><span class="pre">-v</span> <span class="pre">${HOME}/code:/data</span></tt> if you have your work locally in a <tt class="docutils literal">code</tt> subdirectory of your home directory. Even simpler, you could do <tt class="docutils literal"><span class="pre">-v</span> <span class="pre">${PWD}:/data</span></tt> if your shell is already within the directory you want to mount.</p>
</div>
<div class="section" id="building-our-first-extension">
<h2 id="building-our-first-extension">Building our first extension</h2>
<p>Let's start with the following code in a file named <tt class="docutils literal">debugging_demo.c</tt>:</p>
<div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span>

<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span>
<span class="nf">say_hello_and_return_none</span><span class="w"> </span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">"Hello from the extension</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">  </span><span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">DebuggingDemoMethods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">{</span><span class="s">"say_hello_and_return_none"</span><span class="p">,</span><span class="w"> </span><span class="n">say_hello_and_return_none</span><span class="p">,</span><span class="w"> </span><span class="n">METH_VARARGS</span><span class="p">,</span>
<span class="w">   </span><span class="s">"Says hello and returns none."</span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span><span class="w">  </span><span class="cm">/* Sentinel */</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">debugging_demo_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"debugging_demo"</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"A simple extension to showcase debugging"</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_methods</span><span class="w"> </span><span class="o">=</span>

<span class="n">PyMODINIT_FUC</span><span class="w"> </span><span class="n">PyInit_debugging_demo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">PyModuleDef_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debugging_demo_module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>I've saved this locally under <tt class="docutils literal"><span class="pre">~/code-demos</span></tt>, so I'm going to launch my docker container with <tt class="docutils literal">docker run <span class="pre">--rm</span> <span class="pre">-it</span> <span class="pre">-w</span> /data <span class="pre">-v</span> <span class="pre">${HOME}/code-demos:/data</span> <span class="pre">willayd/cpython-debugging</span></tt>. A quick <tt class="docutils literal">ls</tt> should confirm you have mounted everything properly:</p>
<div class="highlight"><pre><span></span>willayd@willayd:~$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-it<span class="w"> </span>-w<span class="w"> </span>/data<span class="w"> </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/code-demos:/data<span class="w"> </span>willayd/cpython-debugging
root@4a6161a82673:/data#<span class="w"> </span>ls
debugging_demo.c
root@4a6161a82673:/data#
</pre></div>
<p>We can build our C module into a shared library, after which we will be able to load it into Python.</p>
<div class="highlight"><pre><span></span>root@12a481d4fa4c:/data#<span class="w"> </span>gcc<span class="w"> </span>-g3<span class="w"> </span>-Wall<span class="w"> </span>-Werror<span class="w"> </span>-std<span class="o">=</span>c17<span class="w"> </span>-shared<span class="w"> </span>-fPIC<span class="w"> </span>-I/usr/local/include/python3.10d<span class="w"> </span>debugging_demo.c<span class="w"> </span>-o<span class="w"> </span>debugging_demo.so
root@12a481d4fa4c:/data#<span class="w"> </span>ls
debugging_demo.c<span class="w">  </span>debugging_demo.so
</pre></div>
<p><tt class="docutils literal">gcc</tt> is our tool for building the code, and all of the flags we provide here are documented in the <a class="reference external" href="https://gcc.gnu.org/onlinedocs/gcc/Invoking-GCC.html">GCC Command Options</a>.</p>
<p><tt class="docutils literal"><span class="pre">-g3</span></tt> instructs gcc to insert debugging information into the target, including macros. Without this, you may not properly be able to debug your application, may be unable to inspect source code, and may see things like <tt class="docutils literal">optimized out</tt> when inspecting variables in gcc.</p>
<p><tt class="docutils literal"><span class="pre">-Wall</span></tt> turns on a lot of warnings (not all) and pairs well with <tt class="docutils literal"><span class="pre">-Werror</span></tt>. For new C developers, I always suggest using these two. Coming from higher level languages like Python you may be used to ignoring warnings, but in C most warnings you get as a new developer really are critical coding errors.</p>
<p><tt class="docutils literal"><span class="pre">-shared</span></tt> and <tt class="docutils literal"><span class="pre">-fPIC</span></tt> are both required for building a shared library, and <tt class="docutils literal"><span class="pre">-I/usr/local/include/python3.10d</span></tt> allows gcc to find our <tt class="docutils literal">Python.h</tt> header file. All of these are necessary to make our extension loadable from Python.</p>
<p><tt class="docutils literal"><span class="pre">-o</span> debugging_demo.so</tt> created our shared library with an <tt class="docutils literal">.so</tt> extension, which is common on GNU/Linux platforms. On macOS you may see a similar concept with a <tt class="docutils literal">.dylib</tt> extension, whereas Windows has <tt class="docutils literal">.dll</tt></p>
<p>Now that this shared library is available, it can be loaded, inspected and executed from the Python interpreter.</p>
<div class="highlight"><pre><span></span>root@12a481d4fa4c:/data#<span class="w"> </span>python3
Python<span class="w"> </span><span class="m">3</span>.10.10+<span class="w"> </span><span class="o">(</span>heads/3.10:bac3fe7,<span class="w"> </span>Feb<span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="m">2023</span>,<span class="w"> </span><span class="m">05</span>:56:35<span class="o">)</span><span class="w"> </span><span class="o">[</span>GCC<span class="w"> </span><span class="m">11</span>.3.0<span class="o">]</span><span class="w"> </span>on<span class="w"> </span>linux
Type<span class="w"> </span><span class="s2">"help"</span>,<span class="w"> </span><span class="s2">"copyright"</span>,<span class="w"> </span><span class="s2">"credits"</span><span class="w"> </span>or<span class="w"> </span><span class="s2">"license"</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>information.
&gt;&gt;&gt;<span class="w"> </span>import<span class="w"> </span>debugging_demo
&gt;&gt;&gt;<span class="w"> </span>debugging_demo.__doc__
<span class="s1">'A simple extension to showcase debugging'</span>
&gt;&gt;&gt;<span class="w"> </span>dir<span class="o">(</span>debugging_demo<span class="o">)</span>
<span class="o">[</span><span class="s1">'__doc__'</span>,<span class="w"> </span><span class="s1">'__file__'</span>,<span class="w"> </span><span class="s1">'__loader__'</span>,<span class="w"> </span><span class="s1">'__name__'</span>,<span class="w"> </span><span class="s1">'__package__'</span>,<span class="w"> </span><span class="s1">'__spec__'</span>,<span class="w"> </span><span class="s1">'say_hello_and_return_none'</span><span class="o">]</span>
&gt;&gt;&gt;<span class="w"> </span>debugging_demo.say_hello_and_return_none.__doc__
<span class="s1">'Says hello and returns none.'</span>
&gt;&gt;&gt;<span class="w"> </span>debugging_demo.say_hello_and_return_none<span class="o">()</span>
Hello<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span>extension
</pre></div>
</div>
<div class="section" id="inspecting-things-with-gdb">
<h2 id="inspecting-things-with-gdb">Inspecting things with gdb</h2>
<p>If we wanted to look at the intermediate state of things, we can pause execution and move around the stack like we did with <tt class="docutils literal">pdb</tt> in the previous article, but this time we will be using <tt class="docutils literal">gdb</tt>. To get started, simply run <tt class="docutils literal">gdb python3</tt>. Thereafter, <tt class="docutils literal">help</tt> is a good place to start.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="nb">help</span>
List<span class="w"> </span>of<span class="w"> </span>classes<span class="w"> </span>of<span class="w"> </span>commands:

aliases<span class="w"> </span>--<span class="w"> </span>User-defined<span class="w"> </span>aliases<span class="w"> </span>of<span class="w"> </span>other<span class="w"> </span>commands.
breakpoints<span class="w"> </span>--<span class="w"> </span>Making<span class="w"> </span>program<span class="w"> </span>stop<span class="w"> </span>at<span class="w"> </span>certain<span class="w"> </span>points.
data<span class="w"> </span>--<span class="w"> </span>Examining<span class="w"> </span>data.
files<span class="w"> </span>--<span class="w"> </span>Specifying<span class="w"> </span>and<span class="w"> </span>examining<span class="w"> </span>files.
internals<span class="w"> </span>--<span class="w"> </span>Maintenance<span class="w"> </span>commands.
obscure<span class="w"> </span>--<span class="w"> </span>Obscure<span class="w"> </span>features.
running<span class="w"> </span>--<span class="w"> </span>Running<span class="w"> </span>the<span class="w"> </span>program.
stack<span class="w"> </span>--<span class="w"> </span>Examining<span class="w"> </span>the<span class="w"> </span>stack.
status<span class="w"> </span>--<span class="w"> </span>Status<span class="w"> </span>inquiries.
support<span class="w"> </span>--<span class="w"> </span>Support<span class="w"> </span>facilities.
text-user-interface<span class="w"> </span>--<span class="w"> </span>TUI<span class="w"> </span>is<span class="w"> </span>the<span class="w"> </span>GDB<span class="w"> </span>text<span class="w"> </span>based<span class="w"> </span>interface.
tracepoints<span class="w"> </span>--<span class="w"> </span>Tracing<span class="w"> </span>of<span class="w"> </span>program<span class="w"> </span>execution<span class="w"> </span>without<span class="w"> </span>stopping<span class="w"> </span>the<span class="w"> </span>program.
user-defined<span class="w"> </span>--<span class="w"> </span>User-defined<span class="w"> </span>commands.

Type<span class="w"> </span><span class="s2">"help"</span><span class="w"> </span>followed<span class="w"> </span>by<span class="w"> </span>a<span class="w"> </span>class<span class="w"> </span>name<span class="w"> </span><span class="k">for</span><span class="w"> </span>a<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>commands<span class="w"> </span><span class="k">in</span><span class="w"> </span>that<span class="w"> </span>class.
Type<span class="w"> </span><span class="s2">"help all"</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>all<span class="w"> </span>commands.
Type<span class="w"> </span><span class="s2">"help"</span><span class="w"> </span>followed<span class="w"> </span>by<span class="w"> </span><span class="nb">command</span><span class="w"> </span>name<span class="w"> </span><span class="k">for</span><span class="w"> </span>full<span class="w"> </span>documentation.
Type<span class="w"> </span><span class="s2">"apropos word"</span><span class="w"> </span>to<span class="w"> </span>search<span class="w"> </span><span class="k">for</span><span class="w"> </span>commands<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span><span class="s2">"word"</span>.
Type<span class="w"> </span><span class="s2">"apropos -v word"</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>full<span class="w"> </span>documentation<span class="w"> </span>of<span class="w"> </span>commands<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span><span class="s2">"word"</span>.
Command<span class="w"> </span>name<span class="w"> </span>abbreviations<span class="w"> </span>are<span class="w"> </span>allowed<span class="w"> </span><span class="k">if</span><span class="w"> </span>unambiguous.
<span class="o">(</span>gdb<span class="o">)</span>
</pre></div>
<p>Compared to <tt class="docutils literal">pdb</tt>, there are way more features within <tt class="docutils literal">gdb</tt> to sift through. <tt class="docutils literal">apropos</tt> or going through <tt class="docutils literal">help all</tt> may be a good place to start. The help menu by default uses a very simple pager; instead you may find it useful to open the help in something like <tt class="docutils literal">less</tt> using a pipe, i.e. <tt class="docutils literal">pipe help all | less</tt>.</p>
<p>The <tt class="docutils literal">help status</tt> subsection introduces us to the <tt class="docutils literal">info</tt> command. <tt class="docutils literal">info breakpoint</tt> always lists your breakpoints, of which we have none right now.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span>breakpoint
No<span class="w"> </span>breakpoints<span class="w"> </span>or<span class="w"> </span>watchpoints.
</pre></div>
<p><tt class="docutils literal">help break</tt> gives great details on how to set a breakpoint. For now, let's go ahead and enter <tt class="docutils literal">break say_hello_and_return_none</tt> to enter the debugger when our function starts to execute.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="nb">break</span><span class="w"> </span>say_hello_and_return_none
Function<span class="w"> </span><span class="s2">"say_hello_and_return_none"</span><span class="w"> </span>not<span class="w"> </span>defined.
Make<span class="w"> </span>breakpoint<span class="w"> </span>pending<span class="w"> </span>on<span class="w"> </span>future<span class="w"> </span>shared<span class="w"> </span>library<span class="w"> </span>load?<span class="w"> </span><span class="o">(</span>y<span class="w"> </span>or<span class="w"> </span><span class="o">[</span>n<span class="o">])</span><span class="w"> </span>y
Breakpoint<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>say_hello_and_return_none<span class="o">)</span><span class="w"> </span>pending.
</pre></div>
<p>Python has not yet loaded our shared library, so gdb isn't sure yet that this function exists. It will become available when we start running our program, so you can enter <tt class="docutils literal">y</tt> when prompted above.</p>
<p>At this point go ahead and <tt class="docutils literal">run</tt> to start the Python interpreter that gdb attached to. You can then import the module and execute the function, at which point gdb will come back to the forefront:</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>run
Starting<span class="w"> </span>program:<span class="w"> </span>/usr/local/bin/python3
warning:<span class="w"> </span>Error<span class="w"> </span>disabling<span class="w"> </span>address<span class="w"> </span>space<span class="w"> </span>randomization:<span class="w"> </span>Operation<span class="w"> </span>not<span class="w"> </span>permitted
<span class="o">[</span>Thread<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>libthread_db<span class="w"> </span>enabled<span class="o">]</span>
Using<span class="w"> </span>host<span class="w"> </span>libthread_db<span class="w"> </span>library<span class="w"> </span><span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.
Python<span class="w"> </span><span class="m">3</span>.10.10+<span class="w"> </span><span class="o">(</span>heads/3.10:bac3fe7,<span class="w"> </span>Feb<span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="m">2023</span>,<span class="w"> </span><span class="m">05</span>:56:35<span class="o">)</span><span class="w"> </span><span class="o">[</span>GCC<span class="w"> </span><span class="m">11</span>.3.0<span class="o">]</span><span class="w"> </span>on<span class="w"> </span>linux
Type<span class="w"> </span><span class="s2">"help"</span>,<span class="w"> </span><span class="s2">"copyright"</span>,<span class="w"> </span><span class="s2">"credits"</span><span class="w"> </span>or<span class="w"> </span><span class="s2">"license"</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>information.
&gt;&gt;&gt;<span class="w"> </span>import<span class="w"> </span>debugging_demo
&gt;&gt;&gt;<span class="w"> </span>debugging_demo.say_hello_and_return_none<span class="o">()</span>

Breakpoint<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>say_hello_and_return_none<span class="w"> </span><span class="o">(</span><span class="nv">self</span><span class="o">=</span>0x7f4de7360230,<span class="w"> </span><span class="nv">args</span><span class="o">=</span>0x7f4de7674250<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>debugging_demo.c:7
<span class="m">7</span><span class="w">      </span><span class="nb">printf</span><span class="w"> </span><span class="o">(</span><span class="s2">"Hello from the extension\n"</span><span class="o">)</span><span class="p">;</span>
</pre></div>
<p>Similar to <tt class="docutils literal">pdb</tt> we have a <tt class="docutils literal">backtrace</tt> command (or <tt class="docutils literal">bt</tt> shortcut) to inspect the call stack. Unlike pdb, this shows the call sequence tracing from the bottom up rather than the top down.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>run
<span class="c1">#0  say_hello_and_return_none (self=0x7f4de7360230, args=0x7f4de7674250) at debugging_demo.c:7</span>
<span class="c1">#1  0x0000558c96fed0cb in cfunction_call (func=0x7f4de73603b0, args=&lt;optimized out&gt;, kwargs=&lt;optimized out&gt;)</span>
<span class="w">    </span>at<span class="w"> </span>Objects/methodobject.c:552
<span class="c1">#2  0x0000558c96e0a1c3 in _PyObject_MakeTpCall (tstate=tstate@entry=0x558c97f030b0,</span>
<span class="w">    </span><span class="nv">callable</span><span class="o">=</span>callable@entry<span class="o">=</span>0x7f4de73603b0,<span class="w"> </span><span class="nv">args</span><span class="o">=</span>args@entry<span class="o">=</span>0x7f4de76ea7c0,<span class="w"> </span><span class="nv">nargs</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;,
<span class="w">    </span><span class="nv">keywords</span><span class="o">=</span>keywords@entry<span class="o">=</span>0x0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Objects/call.c:215
<span class="c1">#3  0x0000558c96ec1baa in _PyObject_VectorcallTstate (tstate=0x558c97f030b0, callable=0x7f4de73603b0, args=0x7f4de76ea7c0,</span>
<span class="w">    </span><span class="nv">nargsf</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;,<span class="w"> </span><span class="nv">kwnames</span><span class="o">=</span>0x0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>./Include/cpython/abstract.h:112
<span class="c1">#4  0x0000558c96ec6185 in PyObject_Vectorcall (kwnames=0x0, nargsf=9223372036854775808, args=0x7f4de76ea7c0,</span>
<span class="w">    </span><span class="nv">callable</span><span class="o">=</span>0x7f4de73603b0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>./Include/cpython/abstract.h:123
<span class="c1">#5  call_function (tstate=tstate@entry=0x558c97f030b0, trace_info=trace_info@entry=0x7fffe84db900,</span>
<span class="w">    </span><span class="nv">pp_stack</span><span class="o">=</span>pp_stack@entry<span class="o">=</span>0x7fffe84db8d0,<span class="w"> </span><span class="nv">oparg</span><span class="o">=</span>oparg@entry<span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">kwnames</span><span class="o">=</span>kwnames@entry<span class="o">=</span>0x0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/ceval.c:5893
<span class="c1">#6  0x0000558c96ed355e in _PyEval_EvalFrameDefault (tstate=0x558c97f030b0, f=0x7f4de76ea650, throwflag=&lt;optimized out&gt;)</span>
<span class="w">    </span>at<span class="w"> </span>Python/ceval.c:4181
</pre></div>
<p>Each frame is numbered on the left hand side from 0 (most-recent frame). You can use <tt class="docutils literal">up</tt> and <tt class="docutils literal">down</tt> to navigate the call stack, or you can use the <tt class="docutils literal">frame</tt> command / <tt class="docutils literal">f</tt> shortcut to jump to any particular frame.</p>
<p>Let us go ahead and jump to frame number 2, which is in the cpython source code at <tt class="docutils literal">Objects/call.c</tt> on line 215. We can then use the <tt class="docutils literal">list</tt> / <tt class="docutils literal">l</tt> commands that pdb also has to look at that code.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>f<span class="w"> </span><span class="m">2</span>
<span class="c1">#2  0x0000558c96e0a1c3 in _PyObject_MakeTpCall (tstate=tstate@entry=0x558c97f030b0,</span>
<span class="w">    </span><span class="nv">callable</span><span class="o">=</span>callable@entry<span class="o">=</span>0x7f4de73603b0,<span class="w"> </span><span class="nv">args</span><span class="o">=</span>args@entry<span class="o">=</span>0x7f4de76ea7c0,<span class="w"> </span><span class="nv">nargs</span><span class="o">=</span>&lt;optimized<span class="w"> </span>out&gt;,
<span class="w">    </span><span class="nv">keywords</span><span class="o">=</span>keywords@entry<span class="o">=</span>0x0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Objects/call.c:215
<span class="m">215</span><span class="w">          </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>call<span class="o">(</span>callable,<span class="w"> </span>argstuple,<span class="w"> </span>kwdict<span class="o">)</span><span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>l
<span class="m">210</span><span class="w">      </span><span class="o">}</span>
<span class="m">211</span>
<span class="m">212</span><span class="w">      </span>PyObject<span class="w"> </span>*result<span class="w"> </span><span class="o">=</span><span class="w"> </span>NULL<span class="p">;</span>
<span class="m">213</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>_Py_EnterRecursiveCall<span class="o">(</span>tstate,<span class="w"> </span><span class="s2">" while calling a Python object"</span><span class="o">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="o">)</span>
<span class="m">214</span><span class="w">      </span><span class="o">{</span>
<span class="m">215</span><span class="w">          </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>call<span class="o">(</span>callable,<span class="w"> </span>argstuple,<span class="w"> </span>kwdict<span class="o">)</span><span class="p">;</span>
<span class="m">216</span><span class="w">          </span>_Py_LeaveRecursiveCall<span class="o">(</span>tstate<span class="o">)</span><span class="p">;</span>
<span class="m">217</span><span class="w">      </span><span class="o">}</span>
<span class="m">218</span>
<span class="m">219</span><span class="w">      </span>Py_DECREF<span class="o">(</span>argstuple<span class="o">)</span><span class="p">;</span>
</pre></div>
<p>Let's do <tt class="docutils literal">f 0</tt> to get back to the most current frame. There you can use <tt class="docutils literal">next</tt> / <tt class="docutils literal">n</tt> to advance to the next line, and then <tt class="docutils literal">continue</tt> / <tt class="docutils literal">c</tt> to let the program continue.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>f<span class="w"> </span><span class="m">0</span>
<span class="c1">#0  say_hello_and_return_none (self=0x7f4de7360230, args=0x7f4de7674250) at debugging_demo.c:7</span>
<span class="m">7</span><span class="w">      </span><span class="nb">printf</span><span class="w"> </span><span class="o">(</span><span class="s2">"Hello from the extension\n"</span><span class="o">)</span><span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>n
Hello<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span>extension
<span class="m">8</span><span class="w">      </span>Py_RETURN_NONE<span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>c
Continuing.
&gt;&gt;&gt;
</pre></div>
<p>At the very end we get back to our Python interpret. You can <tt class="docutils literal">quit()</tt> out of this to get back to gdb, and then <tt class="docutils literal">exit</tt> gdb to get back to the shell.</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt;<span class="w"> </span>quit<span class="o">()</span>
<span class="o">[</span>Inferior<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>process<span class="w"> </span><span class="m">57</span><span class="o">)</span><span class="w"> </span>exited<span class="w"> </span>normally<span class="o">]</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="nb">exit</span>
root@ba83cd50f6ec:/data#
</pre></div>
</div>
<div class="section" id="debugging-segmentation-faults">
<h2 id="debugging-segmentation-faults">Debugging Segmentation Faults</h2>
<p>Let's introduce an off-by-one programming error into our source code. We can create a new debugging_demo2.c file with similar but updated content:</p>
<div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span>

<span class="cp">#define NUM_WORDS 4</span>

<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span>
<span class="nf">say_hello_and_return_none</span><span class="w"> </span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">words</span><span class="p">[</span><span class="n">NUM_WORDS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">"Hello"</span><span class="p">,</span>
<span class="w">    </span><span class="s">"from"</span><span class="p">,</span>
<span class="w">    </span><span class="s">"the"</span><span class="p">,</span>
<span class="w">    </span><span class="s">"extension"</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">NUM_WORDS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">"%s "</span><span class="p">,</span><span class="w"> </span><span class="n">words</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">  </span><span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">debugging_demo2_methods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">{</span><span class="s">"say_hello_and_return_none"</span><span class="p">,</span><span class="w"> </span><span class="n">say_hello_and_return_none</span><span class="p">,</span><span class="w"> </span><span class="n">METH_VARARGS</span><span class="p">,</span>
<span class="w">   </span><span class="s">"Says hello and returns none."</span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span><span class="w">  </span><span class="cm">/* Sentinel */</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">debugging_demo2_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"debugging_demo2"</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"A simple extension to showcase debugging"</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debugging_demo2_methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">PyInit_debugging_demo2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">PyModuleDef_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debugging_demo2_module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>Compile with <tt class="docutils literal">gcc <span class="pre">-g3</span> <span class="pre">-Wall</span> <span class="pre">-Werror</span> <span class="pre">-std=c17</span> <span class="pre">-shared</span> <span class="pre">-fPIC</span> <span class="pre">-I/usr/local/include/python3.10d</span> debugging_demo2.c <span class="pre">-o</span> debugging_demo2.so</tt>. A quick <tt class="docutils literal">python3 <span class="pre">-c</span> "import debugging_demo2; <span class="pre">debugging_demo2.say_hello_and_return_none()"</span></tt> this time will likely give you a segmentation fault, with no real error message.</p>
<div class="highlight"><pre><span></span>root@ba83cd50f6ec:/data#<span class="w"> </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">"import debugging_demo2; debugging_demo2.say_hello_and_return_none()"</span>
Segmentation<span class="w"> </span>fault<span class="w"> </span><span class="o">(</span>core<span class="w"> </span>dumped<span class="o">)</span>
</pre></div>
<p>Fortunately, gdb will automatically stop execution on a segfault and give you the ability to inspect your program. Let's start this program using the <tt class="docutils literal"><span class="pre">--args</span></tt> argument to gdb, which will allow us to forward arguments like <tt class="docutils literal"><span class="pre">-c</span> <span class="pre">"..."</span></tt> to the program gdb attaches to (here python3):</p>
<div class="highlight"><pre><span></span>root@ba83cd50f6ec:/data#<span class="w"> </span>gdb<span class="w"> </span>--args<span class="w"> </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">"import debugging_demo2; debugging_demo2.say_hello_and_return_none()"</span>
GNU<span class="w"> </span>gdb<span class="w"> </span><span class="o">(</span>GDB<span class="o">)</span><span class="w"> </span><span class="m">12</span>.1
Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2022</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
License<span class="w"> </span>GPLv3+:<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>version<span class="w"> </span><span class="m">3</span><span class="w"> </span>or<span class="w"> </span>later<span class="w"> </span>&lt;http://gnu.org/licenses/gpl.html&gt;
...
For<span class="w"> </span>help,<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">"help"</span>.
Type<span class="w"> </span><span class="s2">"apropos word"</span><span class="w"> </span>to<span class="w"> </span>search<span class="w"> </span><span class="k">for</span><span class="w"> </span>commands<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span><span class="s2">"word"</span>...
Reading<span class="w"> </span>symbols<span class="w"> </span>from<span class="w"> </span>python3...
<span class="o">(</span>gdb<span class="o">)</span>
</pre></div>
<p>Enter <tt class="docutils literal">run</tt> and things will pause when the segmentation fault occurs:</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>run
Starting<span class="w"> </span>program:<span class="w"> </span>/usr/local/bin/python3<span class="w"> </span>-c<span class="w"> </span>import<span class="se">\ </span>debugging_demo2<span class="se">\;\ </span>debugging_demo2.say_hello_and_return_none<span class="se">\(\)</span>
warning:<span class="w"> </span>Error<span class="w"> </span>disabling<span class="w"> </span>address<span class="w"> </span>space<span class="w"> </span>randomization:<span class="w"> </span>Operation<span class="w"> </span>not<span class="w"> </span>permitted
<span class="o">[</span>Thread<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>libthread_db<span class="w"> </span>enabled<span class="o">]</span>
Using<span class="w"> </span>host<span class="w"> </span>libthread_db<span class="w"> </span>library<span class="w"> </span><span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.

Program<span class="w"> </span>received<span class="w"> </span>signal<span class="w"> </span>SIGSEGV,<span class="w"> </span>Segmentation<span class="w"> </span>fault.
0x00007ffb409dc97d<span class="w"> </span><span class="k">in</span><span class="w"> </span>??<span class="w"> </span><span class="o">()</span><span class="w"> </span>from<span class="w"> </span>/lib/x86_64-linux-gnu/libc.so.6
<span class="o">(</span>gdb<span class="o">)</span>
</pre></div>
<p>If we inspect the backtrace, we will see that the first three frames are from <tt class="docutils literal"><span class="pre">/lib/x86_64-linux-gnu/libc.so.</span></tt>, which is the part of the standard library on GNU/Linux</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>bt
<span class="c1">#0  0x00007ffb409dc97d in ?? () from /lib/x86_64-linux-gnu/libc.so.6</span>
<span class="c1">#1  0x00007ffb408b5db1 in ?? () from /lib/x86_64-linux-gnu/libc.so.6</span>
<span class="c1">#2  0x00007ffb4089f81f in printf () from /lib/x86_64-linux-gnu/libc.so.6</span>
<span class="c1">#3  0x00007ffb405b5245 in say_hello_and_return_none (self=0x7ffb4065dc10, args=0x7ffb406e4250) at debugging_demo.c:15</span>
<span class="c1">#4  0x000055bed6af30cb in cfunction_call (func=0x7ffb406a2b10, args=&lt;optimized out&gt;, kwargs=&lt;optimized out&gt;)</span>
<span class="w">    </span>at<span class="w"> </span>Objects/methodobject.c:552
</pre></div>
<p>In contrast to the last 2 frames, there is also barely any function information. This is because these libraries are heavily optimized without any debugging symbols (remember the <cite>-g3</cite> flag we using during compilation) so gdb can't do much besides tell us the memory location of the calls. If you ever try to debug a program and can't see the symbols you are looking for, keep this in mind.</p>
<p>In any case, we are going to assume there is no bug in the standard library and jump back to <tt class="docutils literal">f 3</tt> to inspect our code. There a quick <tt class="docutils literal">info locals</tt> will tell us about the local variables.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>f<span class="w"> </span><span class="m">3</span>
<span class="c1">#3  0x00007ffb405b5245 in say_hello_and_return_none (self=0x7ffb4065dc10, args=0x7ffb406e4250) at debugging_demo.c:15</span>
<span class="m">15</span><span class="w">       </span><span class="nb">printf</span><span class="w"> </span><span class="o">(</span><span class="s2">"%s "</span>,<span class="w"> </span>words<span class="o">[</span>i<span class="o">])</span><span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span>locals
<span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<span class="nv">words</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>0x7ffb405b6000<span class="w"> </span><span class="s2">"Hello"</span>,<span class="w"> </span>0x7ffb405b6006<span class="w"> </span><span class="s2">"from"</span>,<span class="w"> </span>0x7ffb405b600b<span class="w"> </span><span class="s2">"the"</span>,<span class="w"> </span>0x7ffb405b600f<span class="w"> </span><span class="s2">"extension"</span><span class="o">}</span>
</pre></div>
<p>Since C is a 0-indexed language, the expression <tt class="docutils literal">words[i]</tt> tries to access memory that is out of bounds, which is the root cause of our segmentation fault:</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>words<span class="o">[</span><span class="m">3</span><span class="o">]</span>
<span class="nv">$1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x7ffb405b600f<span class="w"> </span><span class="s2">"extension"</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>words<span class="o">[</span>i<span class="o">]</span>
<span class="nv">$2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x2e<span class="w"> </span>&lt;error:<span class="w"> </span>Cannot<span class="w"> </span>access<span class="w"> </span>memory<span class="w"> </span>at<span class="w"> </span>address<span class="w"> </span>0x2e&gt;
</pre></div>
<p>A quick <tt class="docutils literal">l</tt> lists the code surrounding this function.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>l
<span class="m">12</span><span class="w">       </span><span class="s2">"the"</span>,
<span class="m">13</span><span class="w">       </span><span class="s2">"extension"</span>
<span class="m">14</span><span class="w">     </span><span class="o">}</span><span class="p">;</span>
<span class="m">15</span>
<span class="m">16</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="o">(</span>int<span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span>&lt;<span class="o">=</span><span class="w"> </span>NUM_WORDS<span class="p">;</span><span class="w"> </span>i++<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="m">17</span><span class="w">       </span><span class="nb">printf</span><span class="w"> </span><span class="o">(</span><span class="s2">"%s "</span>,<span class="w"> </span>words<span class="o">[</span>i<span class="o">])</span><span class="p">;</span>
<span class="m">18</span><span class="w">     </span><span class="o">}</span>
<span class="m">19</span>
<span class="m">20</span><span class="w">     </span>printf<span class="o">(</span><span class="s2">"\n"</span><span class="o">)</span><span class="p">;</span>
<span class="m">21</span><span class="w">     </span>Py_RETURN_NONE<span class="p">;</span>
</pre></div>
<p>The error is on line 14 and to have this program execute properly we would need to change <tt class="docutils literal">for (int i = 0; i &lt;= NUM_WORDS; <span class="pre">i++)</span></tt> to <tt class="docutils literal">for (int i = 0; i &lt;= NUM_WORDS; <span class="pre">i++)</span></tt>, keeping our array access in bounds.</p>
<p>As an aside, if we had turned on optimization when compiling this via the <tt class="docutils literal"><span class="pre">-O2</span></tt> flag, gcc would have warned and then errored (as long as you use <tt class="docutils literal"><span class="pre">-Werror</span></tt>) up front. But that would have made debugging less fun.</p>
<div class="highlight"><pre><span></span>root@ba83cd50f6ec:/data#<span class="w"> </span>gcc<span class="w"> </span>-g3<span class="w"> </span>-O2<span class="w"> </span>-Wall<span class="w"> </span>-Werror<span class="w"> </span>-std<span class="o">=</span>c17<span class="w"> </span>-shared<span class="w"> </span>-fPIC<span class="w"> </span>-I/usr/local/include/python3.10d<span class="w"> </span>debugging_demo2.c<span class="w"> </span>-o<span class="w"> </span>debugging_demo2.so
debugging_demo2.c:<span class="w"> </span>In<span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="s1">'say_hello_and_return_none'</span>:
debugging_demo2.c:17:5:<span class="w"> </span>error:<span class="w"> </span>iteration<span class="w"> </span><span class="m">4</span><span class="w"> </span>invokes<span class="w"> </span>undefined<span class="w"> </span>behavior<span class="w"> </span><span class="o">[</span>-Werror<span class="o">=</span>aggressive-loop-optimizations<span class="o">]</span>
<span class="w">   </span><span class="m">17</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="nb">printf</span><span class="w"> </span><span class="o">(</span><span class="s2">"%s "</span>,<span class="w"> </span>words<span class="o">[</span>i<span class="o">])</span><span class="p">;</span>
<span class="w">      </span><span class="p">|</span><span class="w">     </span>^~~~~~~~~~~~~~~~~~~~~~~~
debugging_demo2.c:16:21:<span class="w"> </span>note:<span class="w"> </span>within<span class="w"> </span>this<span class="w"> </span>loop
<span class="w">   </span><span class="m">16</span><span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="o">(</span>int<span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span>&lt;<span class="o">=</span><span class="w"> </span>NUM_WORDS<span class="p">;</span><span class="w"> </span>i++<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">      </span><span class="p">|</span><span class="w">                     </span>^
cc1:<span class="w"> </span>all<span class="w"> </span>warnings<span class="w"> </span>being<span class="w"> </span>treated<span class="w"> </span>as<span class="w"> </span>errors
</pre></div>
</div>
<div class="section" id="debugging-python-c-data-exchange">
<h2 id="debugging-python-c-data-exchange">Debugging Python-&gt;C data exchange</h2>
<p>CPython distributes a <a class="reference external" href="https://sourceware.org/gdb/onlinedocs/gdb/Python.html#Python">gdb python extension</a> that bridges the gap between what you as a Python developer see at runtime versus what gdb knows about the objects it sees at a lower level. This extension is housed in the <a class="reference external" href="https://github.com/python/cpython/blob/main/Tools/gdb/libpython.py">CPython source code</a>, which we also have hanging around at <tt class="docutils literal">/clones</tt> in our Docker image.</p>
<p>Let's continue expanding on our previous extension, this time naming it <tt class="docutils literal">debugging_demo3.c</tt>. Rather than being self contained, the new extension will print whatever name you pass to it through the Python interpreter. Our initial structure looks like this:</p>
<div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span>

<span class="cp">#define NUM_WORDS 4</span>

<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span>
<span class="nf">say_hello_and_return_none</span><span class="w"> </span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="s">"O"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyUnicode_AsUTF8</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Hello, %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">);</span>
<span class="w">  </span><span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">debugging_demo3_methods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">{</span><span class="s">"say_hello_and_return_none"</span><span class="p">,</span><span class="w"> </span><span class="n">say_hello_and_return_none</span><span class="p">,</span><span class="w"> </span><span class="n">METH_VARARGS</span><span class="p">,</span>
<span class="w">   </span><span class="s">"Says hello and returns none."</span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span><span class="w">  </span><span class="cm">/* Sentinel */</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">debugging_demo3_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"debugging_demo3"</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"A simple extension to showcase debugging"</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debugging_demo3_methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">PyInit_debugging_demo3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">PyModuleDef_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debugging_demo3_module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>We need to build this extension just as we have done before, this time using <tt class="docutils literal">gcc <span class="pre">-g3</span> <span class="pre">-Wall</span> <span class="pre">-Werror</span> <span class="pre">-std=c17</span> <span class="pre">-shared</span> <span class="pre">-fPIC</span> <span class="pre">-I/usr/local/include/python3.10d</span> debugging_demo3.c <span class="pre">-o</span> debugging_demo3.so</tt>.</p>
<p>If you look closely at the source code above we have introduced <a class="reference external" href="https://docs.python.org/3/c-api/arg.html">PyArg_ParseTuple</a>, which handles unpacking function arguments into local variables. Our function takes 1 and only 1 argument in its current form; attempting to call it with anything else will set the global Python error indicator, hit the <tt class="docutils literal">return NULL;</tt> statement, and propagate the error back to the Python runtime. That's a lot of power packed into a few lines of code.</p>
<div class="highlight"><pre><span></span>root@ba83cd50f6ec:/data#<span class="w"> </span>python3
Python<span class="w"> </span><span class="m">3</span>.10.10+<span class="w"> </span><span class="o">(</span>heads/3.10:bac3fe7,<span class="w"> </span>Feb<span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="m">2023</span>,<span class="w"> </span><span class="m">05</span>:56:35<span class="o">)</span><span class="w"> </span><span class="o">[</span>GCC<span class="w"> </span><span class="m">11</span>.3.0<span class="o">]</span><span class="w"> </span>on<span class="w"> </span>linux
Type<span class="w"> </span><span class="s2">"help"</span>,<span class="w"> </span><span class="s2">"copyright"</span>,<span class="w"> </span><span class="s2">"credits"</span><span class="w"> </span>or<span class="w"> </span><span class="s2">"license"</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>information.
&gt;&gt;&gt;<span class="w"> </span>import<span class="w"> </span>debugging_demo3
&gt;&gt;&gt;<span class="w"> </span>debugging_demo3.say_hello_and_return_none<span class="o">(</span><span class="s2">"Will"</span><span class="o">)</span>
Hello,<span class="w"> </span>Will
&gt;&gt;&gt;<span class="w"> </span>debugging_demo3.say_hello_and_return_none<span class="o">()</span>
Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;stdin&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
TypeError:<span class="w"> </span><span class="k">function</span><span class="w"> </span>takes<span class="w"> </span>exactly<span class="w"> </span><span class="m">1</span><span class="w"> </span>argument<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>given<span class="o">)</span>
&gt;&gt;&gt;<span class="w"> </span>debugging_demo3.say_hello_and_return_none<span class="o">(</span><span class="s2">"Will"</span>,<span class="w"> </span><span class="s2">"Ayd"</span><span class="o">)</span>
Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;stdin&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
TypeError:<span class="w"> </span><span class="k">function</span><span class="w"> </span>takes<span class="w"> </span>exactly<span class="w"> </span><span class="m">1</span><span class="w"> </span>argument<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>given<span class="o">)</span>
</pre></div>
<p>Things work great until you try passing through something that is not a unicode object.</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt;<span class="w"> </span>debugging_demo3.say_hello_and_return_none<span class="o">(</span><span class="m">555</span><span class="o">)</span>
Hello,<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
Fatal<span class="w"> </span>Python<span class="w"> </span>error:<span class="w"> </span>_Py_CheckFunctionResult:<span class="w"> </span>a<span class="w"> </span><span class="k">function</span><span class="w"> </span>returned<span class="w"> </span>a<span class="w"> </span>result<span class="w"> </span>with<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span><span class="nb">set</span>
Python<span class="w"> </span>runtime<span class="w"> </span>state:<span class="w"> </span>initialized
TypeError:<span class="w"> </span>bad<span class="w"> </span>argument<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>built-in<span class="w"> </span>operation

The<span class="w"> </span>above<span class="w"> </span>exception<span class="w"> </span>was<span class="w"> </span>the<span class="w"> </span>direct<span class="w"> </span>cause<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>exception:

SystemError:<span class="w"> </span>&lt;built-in<span class="w"> </span><span class="k">function</span><span class="w"> </span>say_hello_and_return_none&gt;<span class="w"> </span>returned<span class="w"> </span>a<span class="w"> </span>result<span class="w"> </span>with<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span><span class="nb">set</span>

Current<span class="w"> </span>thread<span class="w"> </span>0x00007f5dd4cbb740<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>first<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;stdin&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;

Extension<span class="w"> </span>modules:<span class="w"> </span>debugging_demo3<span class="w"> </span><span class="o">(</span>total:<span class="w"> </span><span class="m">1</span><span class="o">)</span>
Aborted<span class="w"> </span><span class="o">(</span>core<span class="w"> </span>dumped<span class="o">)</span>
</pre></div>
<p>This time the program aborted instead of having a segmentation fault. That said, gdb will still allow you to jump in and inspect the state of things prior to termination.</p>
<div class="highlight"><pre><span></span>root@ba83cd50f6ec:/data#<span class="w"> </span>gdb<span class="w"> </span>--args<span class="w"> </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">"import debugging_demo3; debugging_demo3.say_hello_and_return_none(555)"</span>
Reading<span class="w"> </span>symbols<span class="w"> </span>from<span class="w"> </span>python3...
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>run
Starting<span class="w"> </span>program:<span class="w"> </span>/usr/local/bin/python3<span class="w"> </span>-c<span class="w"> </span>import<span class="se">\ </span>debugging_demo3<span class="se">\;\ </span>debugging_demo3.say_hello_and_return_none<span class="se">\(</span><span class="m">555</span><span class="se">\)</span>
warning:<span class="w"> </span>Error<span class="w"> </span>disabling<span class="w"> </span>address<span class="w"> </span>space<span class="w"> </span>randomization:<span class="w"> </span>Operation<span class="w"> </span>not<span class="w"> </span>permitted
<span class="o">[</span>Thread<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>libthread_db<span class="w"> </span>enabled<span class="o">]</span>
Using<span class="w"> </span>host<span class="w"> </span>libthread_db<span class="w"> </span>library<span class="w"> </span><span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.
Hello,<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
Fatal<span class="w"> </span>Python<span class="w"> </span>error:<span class="w"> </span>_Py_CheckFunctionResult:<span class="w"> </span>a<span class="w"> </span><span class="k">function</span><span class="w"> </span>returned<span class="w"> </span>a<span class="w"> </span>result<span class="w"> </span>with<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span><span class="nb">set</span>
Python<span class="w"> </span>runtime<span class="w"> </span>state:<span class="w"> </span>initialized
TypeError:<span class="w"> </span>bad<span class="w"> </span>argument<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>built-in<span class="w"> </span>operation

The<span class="w"> </span>above<span class="w"> </span>exception<span class="w"> </span>was<span class="w"> </span>the<span class="w"> </span>direct<span class="w"> </span>cause<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>exception:

SystemError:<span class="w"> </span>&lt;built-in<span class="w"> </span><span class="k">function</span><span class="w"> </span>say_hello_and_return_none&gt;<span class="w"> </span>returned<span class="w"> </span>a<span class="w"> </span>result<span class="w"> </span>with<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span><span class="nb">set</span>

Current<span class="w"> </span>thread<span class="w"> </span>0x00007f9b27e91740<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>first<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;string&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;

Extension<span class="w"> </span>modules:<span class="w"> </span>debugging_demo3<span class="w"> </span><span class="o">(</span>total:<span class="w"> </span><span class="m">1</span><span class="o">)</span>

Program<span class="w"> </span>received<span class="w"> </span>signal<span class="w"> </span>SIGABRT,<span class="w"> </span>Aborted.
0x00007f9b27f2aa7c<span class="w"> </span><span class="k">in</span><span class="w"> </span>pthread_kill<span class="w"> </span><span class="o">()</span><span class="w"> </span>from<span class="w"> </span>/lib/x86_64-linux-gnu/libc.so.6
</pre></div>
<p>When you look at the backtrace here, you won't see any of our user code:</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>bt
<span class="c1">#0  0x00007f9b27f2aa7c in pthread_kill () from /lib/x86_64-linux-gnu/libc.so.6</span>
<span class="c1">#1  0x00007f9b27ed6476 in raise () from /lib/x86_64-linux-gnu/libc.so.6</span>
<span class="c1">#2  0x00007f9b27ebc7f3 in abort () from /lib/x86_64-linux-gnu/libc.so.6</span>
<span class="c1">#3  0x0000555c45a8505b in fatal_error_exit (status=&lt;optimized out&gt;) at Python/pylifecycle.c:2553</span>
<span class="c1">#4  0x0000555c45a895c7 in fatal_error (fd=2, header=header@entry=1,</span>
<span class="w">    </span><span class="nv">prefix</span><span class="o">=</span>prefix@entry<span class="o">=</span>0x555c45c08a60<span class="w"> </span>&lt;__func__.18&gt;<span class="w"> </span><span class="s2">"_Py_CheckFunctionResult"</span>,
<span class="w">    </span><span class="nv">msg</span><span class="o">=</span>msg@entry<span class="o">=</span>0x555c45c08528<span class="w"> </span><span class="s2">"a function returned a result with an exception set"</span>,<span class="w"> </span><span class="nv">status</span><span class="o">=</span>status@entry<span class="o">=</span>-1<span class="o">)</span>
<span class="w">    </span>at<span class="w"> </span>Python/pylifecycle.c:2734
<span class="c1">#5  0x0000555c45a89630 in _Py_FatalErrorFunc (func=func@entry=0x555c45c08a60 &lt;__func__.18&gt; "_Py_CheckFunctionResult",</span>
</pre></div>
<p>This is a bit unfortunate because we can't directly trace back to our function. With that said, the message <tt class="docutils literal">a function returned a result with an exception set</tt> clues us in on where we need to look. CPython manages one global error indicator queryable via <a class="reference external" href="https://docs.python.org/3/c-api/exceptions.html">PyErr_Occurred()</a>.</p>
<p>To do this, let's set a <tt class="docutils literal">break say_hello_and_return_none</tt> to pause execution when we enter our function.  Then <tt class="docutils literal">run</tt> to get to that point and add a <tt class="docutils literal">watch PyErr_Occurred()</tt> to the mix.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="nb">break</span><span class="w"> </span>say_hello_and_return_none
Breakpoint<span class="w"> </span><span class="m">1</span><span class="w"> </span>at<span class="w"> </span>0x7f0a8fbf5200:<span class="w"> </span>file<span class="w"> </span>debugging_demo3.c,<span class="w"> </span>line<span class="w"> </span><span class="m">8</span>.
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>run
The<span class="w"> </span>program<span class="w"> </span>being<span class="w"> </span>debugged<span class="w"> </span>has<span class="w"> </span>been<span class="w"> </span>started<span class="w"> </span>already.
Start<span class="w"> </span>it<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span>beginning?<span class="w"> </span><span class="o">(</span>y<span class="w"> </span>or<span class="w"> </span>n<span class="o">)</span><span class="w"> </span>y
Starting<span class="w"> </span>program:<span class="w"> </span>/usr/local/bin/python3<span class="w"> </span>-c<span class="w"> </span>import<span class="se">\ </span>debugging_demo3<span class="se">\;\ </span>debugging_demo3.say_hello_and_return_none<span class="se">\(</span><span class="m">555</span><span class="se">\)</span>
warning:<span class="w"> </span>Error<span class="w"> </span>disabling<span class="w"> </span>address<span class="w"> </span>space<span class="w"> </span>randomization:<span class="w"> </span>Operation<span class="w"> </span>not<span class="w"> </span>permitted
<span class="o">[</span>Thread<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>libthread_db<span class="w"> </span>enabled<span class="o">]</span>
Using<span class="w"> </span>host<span class="w"> </span>libthread_db<span class="w"> </span>library<span class="w"> </span><span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.

Breakpoint<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>say_hello_and_return_none<span class="w"> </span><span class="o">(</span><span class="nv">self</span><span class="o">=</span>0x7f58e60305f0,<span class="w"> </span><span class="nv">args</span><span class="o">=</span>0x7f58e5fe98b0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>debugging_demo3.c:8
<span class="m">8</span><span class="w">    </span><span class="o">{</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>watch<span class="w"> </span>PyErr_Occurred<span class="o">()</span>
Watchpoint<span class="w"> </span><span class="m">2</span>:<span class="w"> </span>PyErr_Occurred<span class="o">()</span>
</pre></div>
<p>At this point <tt class="docutils literal">info break</tt> should show us the two conditions under which gdb will pause, either on <tt class="docutils literal">say_hello_and_return_none</tt> entry or when the <tt class="docutils literal">PyErr_Occurred()</tt> value changes.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span><span class="nb">break</span>
Num<span class="w">     </span>Type<span class="w">           </span>Disp<span class="w"> </span>Enb<span class="w"> </span>Address<span class="w">            </span>What
<span class="m">1</span><span class="w">       </span>breakpoint<span class="w">     </span>keep<span class="w"> </span>y<span class="w">   </span>0x00007f58e5f87200<span class="w"> </span><span class="k">in</span><span class="w"> </span>say_hello_and_return_none<span class="w"> </span>at<span class="w"> </span>debugging_demo3.c:8
<span class="w">     </span>breakpoint<span class="w"> </span>already<span class="w"> </span>hit<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nb">time</span>
<span class="m">2</span><span class="w">       </span>watchpoint<span class="w">     </span>keep<span class="w"> </span>y<span class="w">                      </span>PyErr_Occurred<span class="o">()</span>
</pre></div>
<p>Type <tt class="docutils literal">c</tt> to continue along and you will see that the watchpoint gets hit:</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>c
Continuing.

Watchpoint<span class="w"> </span><span class="m">2</span>:<span class="w"> </span>PyErr_Occurred<span class="o">()</span>

Old<span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>PyObject<span class="w"> </span>*<span class="o">)</span><span class="w"> </span>0x0
New<span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>PyObject<span class="w"> </span>*<span class="o">)</span><span class="w"> </span>0x55ccfb73cc20<span class="w"> </span>&lt;_PyExc_TypeError&gt;
_PyErr_Restore<span class="w"> </span><span class="o">(</span><span class="nv">tstate</span><span class="o">=</span>tstate@entry<span class="o">=</span>0x55ccfcb82930,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>type@entry<span class="o">=</span>0x55ccfb73cc20<span class="w"> </span>&lt;_PyExc_TypeError&gt;,<span class="w"> </span><span class="nv">value</span><span class="o">=</span>value@entry<span class="o">=</span>0x7f58e6057640,<span class="w"> </span><span class="nv">traceback</span><span class="o">=</span>0x0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/errors.c:60
<span class="m">60</span><span class="w">       </span>tstate-&gt;curexc_value<span class="w"> </span><span class="o">=</span><span class="w"> </span>value<span class="p">;</span>
</pre></div>
<p>The watchpoint wasn't hit within our code, but internal to CPython. No matter - we can inspect the backtrace and see what point in our code base this might happen at.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>bt
<span class="c1">#0  _PyErr_Restore (tstate=tstate@entry=0x55ccfcb82930, type=type@entry=0x55ccfb73cc20 &lt;_PyExc_TypeError&gt;,</span>
<span class="w">    </span><span class="nv">value</span><span class="o">=</span>value@entry<span class="o">=</span>0x7f58e6057640,<span class="w"> </span><span class="nv">traceback</span><span class="o">=</span>0x0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/errors.c:60
<span class="c1">#1  0x000055ccfb455d60 in _PyErr_SetObject (tstate=tstate@entry=0x55ccfcb82930,</span>
<span class="w">    </span><span class="nv">exception</span><span class="o">=</span>exception@entry<span class="o">=</span>0x55ccfb73cc20<span class="w"> </span>&lt;_PyExc_TypeError&gt;,<span class="w"> </span><span class="nv">value</span><span class="o">=</span>value@entry<span class="o">=</span>0x7f58e6057640<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/errors.c:189
<span class="c1">#2  0x000055ccfb455f59 in _PyErr_SetString (tstate=0x55ccfcb82930, exception=0x55ccfb73cc20 &lt;_PyExc_TypeError&gt;,</span>
<span class="w">    </span><span class="nv">string</span><span class="o">=</span>string@entry<span class="o">=</span>0x55ccfb645698<span class="w"> </span><span class="s2">"bad argument type for built-in operation"</span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/errors.c:235
<span class="c1">#3  0x000055ccfb455fdd in PyErr_BadArgument () at Python/errors.c:667</span>
<span class="c1">#4  0x000055ccfb402060 in PyUnicode_AsUTF8AndSize (unicode=&lt;optimized out&gt;, psize=psize@entry=0x0)</span>
<span class="w">    </span>at<span class="w"> </span>Objects/unicodeobject.c:4245
<span class="c1">#5  0x000055ccfb402195 in PyUnicode_AsUTF8 (unicode=&lt;optimized out&gt;) at Objects/unicodeobject.c:4265</span>
<span class="c1">#6  0x00007f58e5f87245 in say_hello_and_return_none (self=0x7f58e60305f0, args=0x7f58e5fe98b0) at debugging_demo3.c:14</span>
</pre></div>
<p>Frame 6 is <tt class="docutils literal">say_hello_and_return_none</tt>, specifically on line 14. You can jump back to that and see the line being called.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>f<span class="w"> </span><span class="m">6</span>
<span class="c1">#6  0x00007f58e5f87245 in say_hello_and_return_none (self=0x7f58e60305f0, args=0x7f58e5fe98b0) at debugging_demo3.c:14</span>
<span class="m">14</span><span class="w">     </span>const<span class="w"> </span>char<span class="w"> </span>*str<span class="w"> </span><span class="o">=</span><span class="w"> </span>PyUnicode_AsUTF8<span class="o">(</span>name<span class="o">)</span><span class="p">;</span>
</pre></div>
<p>We know from our function invocation that we are passed the value <tt class="docutils literal">555</tt> as an argument to the function call. However, you wouldn't know this by trying to print the object in gdb.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>name
<span class="nv">$1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>PyObject<span class="w"> </span>*<span class="o">)</span><span class="w"> </span>0x7f58e6013bc0
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>*name
<span class="nv">$2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="nv">ob_refcnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>,<span class="w"> </span><span class="nv">ob_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x55ccfb73f180<span class="w"> </span>&lt;PyLong_Type&gt;<span class="o">}</span>
</pre></div>
<p>We get <em>some</em> information when dereferencing this object about the basic <tt class="docutils literal">PyObject</tt> struct members. But we'd have to muck around a bit more to see the members that are relevant to longs, or whatever object type it is we inspect.</p>
<p><em>This</em> is where the gdb extension becomes a really powerful abstraction tool. First, we need to load the extension into gdb. This can be done at runtime with the <tt class="docutils literal">source</tt> command pointing to the extension file. In our docker image, this would mean</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>/clones/cpython/Tools/gdb/libpython.py
</pre></div>
<p>Once you have loaded the extension, the default printing mechanism becomes a lot more familiar to Python users.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>name
<span class="nv">$3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">555</span>
</pre></div>
<p>This confirms that the object we have on this line is the same we provided to the function call, so nothing way out of the ordinary is going on. Since the global <tt class="docutils literal">PyErr_Occurred()</tt> indicator was set, we can use <tt class="docutils literal">PyErr_Print()</tt> to get information from the Python runtime about what went wrong. Note that calling this <em>clears</em> the error indicator.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>call<span class="w"> </span>PyErr_PrintEx<span class="o">(</span><span class="m">0</span><span class="o">)</span>
TypeError
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>PyErr_Occurred<span class="o">()</span>
<span class="nv">$4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0
</pre></div>
<p>We called <tt class="docutils literal">PyUnicode_AsUTF8</tt> with a <tt class="docutils literal">PyLong</tt> object even though it expected <tt class="docutils literal">PyUnicode</tt>. In the Python runtime this would automatically trigger an exception and stop things immediately. C doesn't have built-in error handling, so things continue unless you explicitly handle the issue.</p>
<p>Following the pattern of <a class="reference external" href="https://docs.python.org/3/c-api/exceptions.htmlpyerr">CPython Exception Handling</a>, we are going to slightly modify our source code to look like this:</p>
<div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span>

<span class="cp">#define NUM_WORDS 4</span>

<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span>
<span class="nf">say_hello_and_return_none</span><span class="w"> </span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="s">"O"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyUnicode_AsUTF8</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">str</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Hello, %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">);</span>
<span class="w">  </span><span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">debugging_demo3_methods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">{</span><span class="s">"say_hello_and_return_none"</span><span class="p">,</span><span class="w"> </span><span class="n">say_hello_and_return_none</span><span class="p">,</span><span class="w"> </span><span class="n">METH_VARARGS</span><span class="p">,</span>
<span class="w">   </span><span class="s">"Says hello and returns none."</span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span><span class="w">  </span><span class="cm">/* Sentinel */</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">debugging_demo3_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"debugging_demo3"</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"A simple extension to showcase debugging"</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debugging_demo3_methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">PyInit_debugging_demo3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">PyModuleDef_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debugging_demo3_module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>The <tt class="docutils literal">if (str == NULL)</tt> is our way of handling a failed <tt class="docutils literal">PyUnicode_AsUTF8</tt> call. By propagating that <tt class="docutils literal">NULL</tt> value up the call stack, CPython will gracefully handle the error for us when we get back to the Python runtime. To confirm, recompile with <tt class="docutils literal">gcc <span class="pre">-g3</span> <span class="pre">-Wall</span> <span class="pre">-Werror</span> <span class="pre">-std=c17</span> <span class="pre">-shared</span> <span class="pre">-fPIC</span> <span class="pre">-I/usr/local/include/python3.10d</span> debugging_demo3.c <span class="pre">-o</span> debugging_demo3.so</tt>.</p>
<p>If you look closely at the source code above we have introduced <a class="reference external" href="https://docs.python.org/3/c-api/arg.html">PyArg_ParseTuple</a>, which handles unpacking function arguments into local variables. Our function takes 1 and only 1 argument in its current form; attempting to call it with anything else will set the global Python error indicator, hit the <tt class="docutils literal">return NULL;</tt> statement, and propagate the error back to the Python runtime. That's a lot of power packed into a few lines of code.</p>
<div class="highlight"><pre><span></span>root@ba83cd50f6ec:/data#<span class="w"> </span>python3
Python<span class="w"> </span><span class="m">3</span>.10.10+<span class="w"> </span><span class="o">(</span>heads/3.10:bac3fe7,<span class="w"> </span>Feb<span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="m">2023</span>,<span class="w"> </span><span class="m">05</span>:56:35<span class="o">)</span><span class="w"> </span><span class="o">[</span>GCC<span class="w"> </span><span class="m">11</span>.3.0<span class="o">]</span><span class="w"> </span>on<span class="w"> </span>linux
Type<span class="w"> </span><span class="s2">"help"</span>,<span class="w"> </span><span class="s2">"copyright"</span>,<span class="w"> </span><span class="s2">"credits"</span><span class="w"> </span>or<span class="w"> </span><span class="s2">"license"</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>information.
&gt;&gt;&gt;<span class="w"> </span>import<span class="w"> </span>debugging_demo3
&gt;&gt;&gt;<span class="w"> </span>debugging_demo3.say_hello_and_return_none<span class="o">(</span><span class="s2">"Will"</span><span class="o">)</span>
Hello,<span class="w"> </span>Will
&gt;&gt;&gt;<span class="w"> </span>debugging_demo3.say_hello_and_return_none<span class="o">()</span>
Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;stdin&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
TypeError:<span class="w"> </span><span class="k">function</span><span class="w"> </span>takes<span class="w"> </span>exactly<span class="w"> </span><span class="m">1</span><span class="w"> </span>argument<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>given<span class="o">)</span>
&gt;&gt;&gt;<span class="w"> </span>debugging_demo3.say_hello_and_return_none<span class="o">(</span><span class="s2">"Will"</span>,<span class="w"> </span><span class="s2">"Ayd"</span><span class="o">)</span>
Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;stdin&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
TypeError:<span class="w"> </span><span class="k">function</span><span class="w"> </span>takes<span class="w"> </span>exactly<span class="w"> </span><span class="m">1</span><span class="w"> </span>argument<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>given<span class="o">)</span>
</pre></div>
<p>Things work great until you try passing through something that is not a unicode object.</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt;<span class="w"> </span>debugging_demo3.say_hello_and_return_none<span class="o">(</span><span class="m">555</span><span class="o">)</span>
Hello,<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
Fatal<span class="w"> </span>Python<span class="w"> </span>error:<span class="w"> </span>_Py_CheckFunctionResult:<span class="w"> </span>a<span class="w"> </span><span class="k">function</span><span class="w"> </span>returned<span class="w"> </span>a<span class="w"> </span>result<span class="w"> </span>with<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span><span class="nb">set</span>
Python<span class="w"> </span>runtime<span class="w"> </span>state:<span class="w"> </span>initialized
TypeError:<span class="w"> </span>bad<span class="w"> </span>argument<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>built-in<span class="w"> </span>operation

The<span class="w"> </span>above<span class="w"> </span>exception<span class="w"> </span>was<span class="w"> </span>the<span class="w"> </span>direct<span class="w"> </span>cause<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>exception:

SystemError:<span class="w"> </span>&lt;built-in<span class="w"> </span><span class="k">function</span><span class="w"> </span>say_hello_and_return_none&gt;<span class="w"> </span>returned<span class="w"> </span>a<span class="w"> </span>result<span class="w"> </span>with<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span><span class="nb">set</span>

Current<span class="w"> </span>thread<span class="w"> </span>0x00007f5dd4cbb740<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>first<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;stdin&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;

Extension<span class="w"> </span>modules:<span class="w"> </span>debugging_demo3<span class="w"> </span><span class="o">(</span>total:<span class="w"> </span><span class="m">1</span><span class="o">)</span>
Aborted<span class="w"> </span><span class="o">(</span>core<span class="w"> </span>dumped<span class="o">)</span>
</pre></div>
<p>This time the program aborted instead of having a segmentation fault. That said, gdb will still allow you to jump in and inspect the state of things prior to termination.</p>
<div class="highlight"><pre><span></span>root@ba83cd50f6ec:/data#<span class="w"> </span>gdb<span class="w"> </span>--args<span class="w"> </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">"import debugging_demo3; debugging_demo3.say_hello_and_return_none(555)"</span>
Reading<span class="w"> </span>symbols<span class="w"> </span>from<span class="w"> </span>python3...
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>run
Starting<span class="w"> </span>program:<span class="w"> </span>/usr/local/bin/python3<span class="w"> </span>-c<span class="w"> </span>import<span class="se">\ </span>debugging_demo3<span class="se">\;\ </span>debugging_demo3.say_hello_and_return_none<span class="se">\(</span><span class="m">555</span><span class="se">\)</span>
warning:<span class="w"> </span>Error<span class="w"> </span>disabling<span class="w"> </span>address<span class="w"> </span>space<span class="w"> </span>randomization:<span class="w"> </span>Operation<span class="w"> </span>not<span class="w"> </span>permitted
<span class="o">[</span>Thread<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>libthread_db<span class="w"> </span>enabled<span class="o">]</span>
Using<span class="w"> </span>host<span class="w"> </span>libthread_db<span class="w"> </span>library<span class="w"> </span><span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.
Hello,<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
Fatal<span class="w"> </span>Python<span class="w"> </span>error:<span class="w"> </span>_Py_CheckFunctionResult:<span class="w"> </span>a<span class="w"> </span><span class="k">function</span><span class="w"> </span>returned<span class="w"> </span>a<span class="w"> </span>result<span class="w"> </span>with<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span><span class="nb">set</span>
Python<span class="w"> </span>runtime<span class="w"> </span>state:<span class="w"> </span>initialized
TypeError:<span class="w"> </span>bad<span class="w"> </span>argument<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>built-in<span class="w"> </span>operation

The<span class="w"> </span>above<span class="w"> </span>exception<span class="w"> </span>was<span class="w"> </span>the<span class="w"> </span>direct<span class="w"> </span>cause<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>exception:

SystemError:<span class="w"> </span>&lt;built-in<span class="w"> </span><span class="k">function</span><span class="w"> </span>say_hello_and_return_none&gt;<span class="w"> </span>returned<span class="w"> </span>a<span class="w"> </span>result<span class="w"> </span>with<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span><span class="nb">set</span>

Current<span class="w"> </span>thread<span class="w"> </span>0x00007f9b27e91740<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>first<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;string&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;

Extension<span class="w"> </span>modules:<span class="w"> </span>debugging_demo3<span class="w"> </span><span class="o">(</span>total:<span class="w"> </span><span class="m">1</span><span class="o">)</span>

Program<span class="w"> </span>received<span class="w"> </span>signal<span class="w"> </span>SIGABRT,<span class="w"> </span>Aborted.
0x00007f9b27f2aa7c<span class="w"> </span><span class="k">in</span><span class="w"> </span>pthread_kill<span class="w"> </span><span class="o">()</span><span class="w"> </span>from<span class="w"> </span>/lib/x86_64-linux-gnu/libc.so.6
</pre></div>
<p>When you look at the backtrace here, you won't see any of our user code:</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>bt
<span class="c1">#0  0x00007f9b27f2aa7c in pthread_kill () from /lib/x86_64-linux-gnu/libc.so.6</span>
<span class="c1">#1  0x00007f9b27ed6476 in raise () from /lib/x86_64-linux-gnu/libc.so.6</span>
<span class="c1">#2  0x00007f9b27ebc7f3 in abort () from /lib/x86_64-linux-gnu/libc.so.6</span>
<span class="c1">#3  0x0000555c45a8505b in fatal_error_exit (status=&lt;optimized out&gt;) at Python/pylifecycle.c:2553</span>
<span class="c1">#4  0x0000555c45a895c7 in fatal_error (fd=2, header=header@entry=1,</span>
<span class="w">    </span><span class="nv">prefix</span><span class="o">=</span>prefix@entry<span class="o">=</span>0x555c45c08a60<span class="w"> </span>&lt;__func__.18&gt;<span class="w"> </span><span class="s2">"_Py_CheckFunctionResult"</span>,
<span class="w">    </span><span class="nv">msg</span><span class="o">=</span>msg@entry<span class="o">=</span>0x555c45c08528<span class="w"> </span><span class="s2">"a function returned a result with an exception set"</span>,<span class="w"> </span><span class="nv">status</span><span class="o">=</span>status@entry<span class="o">=</span>-1<span class="o">)</span>
<span class="w">    </span>at<span class="w"> </span>Python/pylifecycle.c:2734
<span class="c1">#5  0x0000555c45a89630 in _Py_FatalErrorFunc (func=func@entry=0x555c45c08a60 &lt;__func__.18&gt; "_Py_CheckFunctionResult",</span>
</pre></div>
<p>This is a bit unfortunate because we can't directly trace back to our function. With that said, the message <tt class="docutils literal">a function returned a result with an exception set</tt> clues us in on where we need to look. CPython manages one global error indicator queryable via <a class="reference external" href="https://docs.python.org/3/c-api/exceptions.html">PyErr_Occurred()</a>.</p>
<p>To do this, let's set a <tt class="docutils literal">break say_hello_and_return_none</tt> to pause execution when we enter our function.  Then <tt class="docutils literal">run</tt> to get to that point and add a <tt class="docutils literal">watch PyErr_Occurred()</tt> to the mix.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="nb">break</span><span class="w"> </span>say_hello_and_return_none
Breakpoint<span class="w"> </span><span class="m">1</span><span class="w"> </span>at<span class="w"> </span>0x7f0a8fbf5200:<span class="w"> </span>file<span class="w"> </span>debugging_demo3.c,<span class="w"> </span>line<span class="w"> </span><span class="m">8</span>.
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>run
The<span class="w"> </span>program<span class="w"> </span>being<span class="w"> </span>debugged<span class="w"> </span>has<span class="w"> </span>been<span class="w"> </span>started<span class="w"> </span>already.
Start<span class="w"> </span>it<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span>beginning?<span class="w"> </span><span class="o">(</span>y<span class="w"> </span>or<span class="w"> </span>n<span class="o">)</span><span class="w"> </span>y
Starting<span class="w"> </span>program:<span class="w"> </span>/usr/local/bin/python3<span class="w"> </span>-c<span class="w"> </span>import<span class="se">\ </span>debugging_demo3<span class="se">\;\ </span>debugging_demo3.say_hello_and_return_none<span class="se">\(</span><span class="m">555</span><span class="se">\)</span>
warning:<span class="w"> </span>Error<span class="w"> </span>disabling<span class="w"> </span>address<span class="w"> </span>space<span class="w"> </span>randomization:<span class="w"> </span>Operation<span class="w"> </span>not<span class="w"> </span>permitted
<span class="o">[</span>Thread<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>libthread_db<span class="w"> </span>enabled<span class="o">]</span>
Using<span class="w"> </span>host<span class="w"> </span>libthread_db<span class="w"> </span>library<span class="w"> </span><span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.

Breakpoint<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>say_hello_and_return_none<span class="w"> </span><span class="o">(</span><span class="nv">self</span><span class="o">=</span>0x7f58e60305f0,<span class="w"> </span><span class="nv">args</span><span class="o">=</span>0x7f58e5fe98b0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>debugging_demo3.c:8
<span class="m">8</span><span class="w">    </span><span class="o">{</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>watch<span class="w"> </span>PyErr_Occurred<span class="o">()</span>
Watchpoint<span class="w"> </span><span class="m">2</span>:<span class="w"> </span>PyErr_Occurred<span class="o">()</span>
</pre></div>
<p>At this point <tt class="docutils literal">info break</tt> should show us the two conditions under which gdb will pause, either on <tt class="docutils literal">say_hello_and_return_none</tt> entry or when the <tt class="docutils literal">PyErr_Occurred()</tt> value changes.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>info<span class="w"> </span><span class="nb">break</span>
Num<span class="w">     </span>Type<span class="w">           </span>Disp<span class="w"> </span>Enb<span class="w"> </span>Address<span class="w">            </span>What
<span class="m">1</span><span class="w">       </span>breakpoint<span class="w">     </span>keep<span class="w"> </span>y<span class="w">   </span>0x00007f58e5f87200<span class="w"> </span><span class="k">in</span><span class="w"> </span>say_hello_and_return_none<span class="w"> </span>at<span class="w"> </span>debugging_demo3.c:8
<span class="w">     </span>breakpoint<span class="w"> </span>already<span class="w"> </span>hit<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nb">time</span>
<span class="m">2</span><span class="w">       </span>watchpoint<span class="w">     </span>keep<span class="w"> </span>y<span class="w">                      </span>PyErr_Occurred<span class="o">()</span>
</pre></div>
<p>Type <tt class="docutils literal">c</tt> to continue along and you will see that the watchpoint gets hit:</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>c
Continuing.

Watchpoint<span class="w"> </span><span class="m">2</span>:<span class="w"> </span>PyErr_Occurred<span class="o">()</span>

Old<span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>PyObject<span class="w"> </span>*<span class="o">)</span><span class="w"> </span>0x0
New<span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>PyObject<span class="w"> </span>*<span class="o">)</span><span class="w"> </span>0x55ccfb73cc20<span class="w"> </span>&lt;_PyExc_TypeError&gt;
_PyErr_Restore<span class="w"> </span><span class="o">(</span><span class="nv">tstate</span><span class="o">=</span>tstate@entry<span class="o">=</span>0x55ccfcb82930,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>type@entry<span class="o">=</span>0x55ccfb73cc20<span class="w"> </span>&lt;_PyExc_TypeError&gt;,<span class="w"> </span><span class="nv">value</span><span class="o">=</span>value@entry<span class="o">=</span>0x7f58e6057640,<span class="w"> </span><span class="nv">traceback</span><span class="o">=</span>0x0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/errors.c:60
<span class="m">60</span><span class="w">       </span>tstate-&gt;curexc_value<span class="w"> </span><span class="o">=</span><span class="w"> </span>value<span class="p">;</span>
</pre></div>
<p>The watchpoint wasn't hit within our code, but internal to CPython. No matter - we can inspect the backtrace and see what point in our code base this might happen at.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>bt
<span class="c1">#0  _PyErr_Restore (tstate=tstate@entry=0x55ccfcb82930, type=type@entry=0x55ccfb73cc20 &lt;_PyExc_TypeError&gt;,</span>
<span class="w">    </span><span class="nv">value</span><span class="o">=</span>value@entry<span class="o">=</span>0x7f58e6057640,<span class="w"> </span><span class="nv">traceback</span><span class="o">=</span>0x0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/errors.c:60
<span class="c1">#1  0x000055ccfb455d60 in _PyErr_SetObject (tstate=tstate@entry=0x55ccfcb82930,</span>
<span class="w">    </span><span class="nv">exception</span><span class="o">=</span>exception@entry<span class="o">=</span>0x55ccfb73cc20<span class="w"> </span>&lt;_PyExc_TypeError&gt;,<span class="w"> </span><span class="nv">value</span><span class="o">=</span>value@entry<span class="o">=</span>0x7f58e6057640<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/errors.c:189
<span class="c1">#2  0x000055ccfb455f59 in _PyErr_SetString (tstate=0x55ccfcb82930, exception=0x55ccfb73cc20 &lt;_PyExc_TypeError&gt;,</span>
<span class="w">    </span><span class="nv">string</span><span class="o">=</span>string@entry<span class="o">=</span>0x55ccfb645698<span class="w"> </span><span class="s2">"bad argument type for built-in operation"</span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span>Python/errors.c:235
<span class="c1">#3  0x000055ccfb455fdd in PyErr_BadArgument () at Python/errors.c:667</span>
<span class="c1">#4  0x000055ccfb402060 in PyUnicode_AsUTF8AndSize (unicode=&lt;optimized out&gt;, psize=psize@entry=0x0)</span>
<span class="w">    </span>at<span class="w"> </span>Objects/unicodeobject.c:4245
<span class="c1">#5  0x000055ccfb402195 in PyUnicode_AsUTF8 (unicode=&lt;optimized out&gt;) at Objects/unicodeobject.c:4265</span>
<span class="c1">#6  0x00007f58e5f87245 in say_hello_and_return_none (self=0x7f58e60305f0, args=0x7f58e5fe98b0) at debugging_demo3.c:14</span>
</pre></div>
<p>Frame 6 is <tt class="docutils literal">say_hello_and_return_none</tt>, specifically on line 14. You can jump back to that and see the line being called.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>f<span class="w"> </span><span class="m">6</span>
<span class="c1">#6  0x00007f58e5f87245 in say_hello_and_return_none (self=0x7f58e60305f0, args=0x7f58e5fe98b0) at debugging_demo3.c:14</span>
<span class="m">14</span><span class="w">     </span>const<span class="w"> </span>char<span class="w"> </span>*str<span class="w"> </span><span class="o">=</span><span class="w"> </span>PyUnicode_AsUTF8<span class="o">(</span>name<span class="o">)</span><span class="p">;</span>
</pre></div>
<p>We know from our function invocation that we are passed the value <tt class="docutils literal">555</tt> as an argument to the function call. However, you wouldn't know this by trying to print the object in gdb.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>name
<span class="nv">$1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>PyObject<span class="w"> </span>*<span class="o">)</span><span class="w"> </span>0x7f58e6013bc0
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>*name
<span class="nv">$2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="nv">ob_refcnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>,<span class="w"> </span><span class="nv">ob_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x55ccfb73f180<span class="w"> </span>&lt;PyLong_Type&gt;<span class="o">}</span>
</pre></div>
<p>We get <em>some</em> information when dereferencing this object about the basic <tt class="docutils literal">PyObject</tt> struct members. But we'd have to muck around a bit more to see the members that are relevant to longs, or whatever object type it is we inspect.</p>
<p><em>This</em> is where the gdb extension becomes a really powerful abstraction tool. First, we need to load the extension into gdb. This can be done at runtime with the <tt class="docutils literal">source</tt> command pointing to the extension file. In our docker image, this would mean</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>/clones/cpython/Tools/gdb/libpython.py
</pre></div>
<p>Once you have loaded the extension, the default printing mechanism becomes a lot more familiar to Python users.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>name
<span class="nv">$3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">555</span>
</pre></div>
<p>This confirms that the object we have on this line is the same we provided to the function call, so nothing way out of the ordinary is going on. Since the global <tt class="docutils literal">PyErr_Occurred()</tt> indicator was set, we can use <tt class="docutils literal">PyErr_Print()</tt> to get information from the Python runtime about what went wrong. Note that calling this <em>clears</em> the error indicator.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>call<span class="w"> </span>PyErr_PrintEx<span class="o">(</span><span class="m">0</span><span class="o">)</span>
TypeError
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>PyErr_Occurred<span class="o">()</span>
<span class="nv">$4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0
</pre></div>
<p>We called <tt class="docutils literal">PyUnicode_AsUTF8</tt> with a <tt class="docutils literal">PyLong</tt> object even though it expected <tt class="docutils literal">PyUnicode</tt>. In the Python runtime this would automatically trigger an exception and stop things immediately. C doesn't have built-in error handling, so things continue unless you explicitly handle the issue.</p>
<p>Following the pattern of <a class="reference external" href="https://docs.python.org/3/c-api/exceptions.htmlpyerr">CPython Exception Handling</a>, we are going to slightly modify our source code to look like this:</p>
<div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span>

<span class="cp">#define NUM_WORDS 4</span>

<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span>
<span class="nf">say_hello_and_return_none</span><span class="w"> </span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="s">"O"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyUnicode_AsUTF8</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">str</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Hello, %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">);</span>
<span class="w">  </span><span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">debugging_demo3_methods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">{</span><span class="s">"say_hello_and_return_none"</span><span class="p">,</span><span class="w"> </span><span class="n">say_hello_and_return_none</span><span class="p">,</span><span class="w"> </span><span class="n">METH_VARARGS</span><span class="p">,</span>
<span class="w">   </span><span class="s">"Says hello and returns none."</span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span><span class="w">  </span><span class="cm">/* Sentinel */</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">debugging_demo3_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"debugging_demo3"</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"A simple extension to showcase debugging"</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">m_methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debugging_demo3_methods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">PyInit_debugging_demo3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">PyModuleDef_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debugging_demo3_module</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>The <tt class="docutils literal">if (str == NULL)</tt> is our way of handling a failed <tt class="docutils literal">PyUnicode_AsUTF8</tt> call. By propagating that <tt class="docutils literal">NULL</tt> value up the call stack, CPython will gracefully handle the error for us when we get back to the Python runtime. To confirm, recompile and trying passing the same argument to the function.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="nb">exit</span>
A<span class="w"> </span>debugging<span class="w"> </span>session<span class="w"> </span>is<span class="w"> </span>active.

<span class="w">     </span>Inferior<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">[</span>process<span class="w"> </span><span class="m">515</span><span class="o">]</span><span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>killed.

Quit<span class="w"> </span>anyway?<span class="w"> </span><span class="o">(</span>y<span class="w"> </span>or<span class="w"> </span>n<span class="o">)</span><span class="w"> </span>y
root@ba83cd50f6ec:/data#<span class="w"> </span>gcc<span class="w"> </span>-g3<span class="w"> </span>-Wall<span class="w"> </span>-Werror<span class="w"> </span>-std<span class="o">=</span>c17<span class="w"> </span>-shared<span class="w"> </span>-fPIC<span class="w"> </span>-I/usr/local/include/python3.10d<span class="w"> </span>debugging_demo3.c<span class="w"> </span>-o<span class="w"> </span>debugging_demo3.so
root@ba83cd50f6ec:/data#<span class="w"> </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">"import debugging_demo3; debugging_demo3.say_hello_and_return_none(555)"</span>
Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;string&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
TypeError:<span class="w"> </span>bad<span class="w"> </span>argument<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>built-in<span class="w"> </span>operation
</pre></div>
<p>We still have an error, but the error is the built-in <tt class="docutils literal">TypeError</tt> that we can handle in our Python code if we wanted, instead of the <tt class="docutils literal">SIGABRT</tt> that shut down the application previously.</p>
<p>While not in scope for this article, there are many ways you can improve the above function. You could either change the <a class="reference external" href="https://docs.python.org/3/c-api/arg.html#strings-and-buffers">format string</a> provided to <tt class="docutils literal">PyArg_ParseTuple</tt> to map to something else besides a <tt class="docutils literal">PyObject *</tt>, or alternately mix in a call to <tt class="docutils literal">PyObject_Str</tt> to coerce any object to a unicode object prior to the <tt class="docutils literal">PyUnicode_AsUTF8</tt> call.</p>
</div>
<div class="section" id="closing-thoughts">
<h2 id="closing-thoughts">Closing Thoughts</h2>
<p>Understanding how C and Python interacted was something I struggled with for years. Once unlocked, I found knowledge of how to interact at the lower levels using gdb to be invaluable. I can only hope that this article lays a good foundation for you to build upon.</p>
<p>The only other advice I can offer is to be patient! I've been at this for years and still find myself learning something new every day. Therein lies the true art of programming.</p>
<p>My next article will focus on using the <a class="reference external" href="https://cython.readthedocs.io/en/latest/src/userguide/debugging.html">Cython debugger</a>, which is implemented as a gdb extension. The knowledge in this article is a hugely important stepping stone towards that. If you can understand how to control and debug all of these components, you are in a <em>very</em> good spot when it comes to Python development.</p>
</div>

    <!-- <div class="aspect-w-16 aspect-h-9 mx-auto"></div> CSS placeholder -->
  </div>
  <footer class="flex flex-col mt-10 ">
    <ul class="flex flex-wrap">
        <li
          class="bg-zinc-200 hover:bg-zinc-300 dark:hover:bg-zinc-800 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 mb-2 mr-2 px-3 py-1.5 rounded-md transition ease-in active:-translate-y-1 active:scale-110 duration-75">
          <a href="http://127.0.0.1:8000/tag/c.html">c</a>
        </li>
        <li
          class="bg-zinc-200 hover:bg-zinc-300 dark:hover:bg-zinc-800 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 mb-2 mr-2 px-3 py-1.5 rounded-md transition ease-in active:-translate-y-1 active:scale-110 duration-75">
          <a href="http://127.0.0.1:8000/tag/python.html">python</a>
        </li>
    </ul>
    <div class="flex w-full my-2 bg-zinc-200 dark:bg-zinc-700 rounded-lg">
      <div class="w-1/2 hover:bg-zinc-300 dark:hover:bg-zinc-800 rounded-l-lg">
        <a class="flex flex-col pr-2" href="http://127.0.0.1:8000/fundamental-python-debugging-part-3-cython-extensions.html">
          <div class="mx-4 py-2 text-left">
            <p class="text-zinc-600 dark:text-zinc-300 text-sm">« PREV PAGE</p>
            <p class="text-left py-1 hover:underline">Fundamental Python Debugging Part 3 - Cython Extensions</p>
          </div>
        </a>
      </div>
      <div class="w-1/2 hover:bg-zinc-300 dark:hover:bg-zinc-800 rounded-r-lg ">
        <a class="flex flex-col" href="http://127.0.0.1:8000/fundamental-python-debugging-part-1-python.html">
          <div class="text-right mx-4 py-2">
            <p class="text-zinc-600 dark:text-zinc-300 text-sm">NEXT PAGE »</p>
            <p class="text-right py-1 hover:underline">Fundamental Python Debugging Part 1 - Python</p>
          </div>
        </a>
      </div>
    </div>
    <div class="flex bg-zinc-200 dark:bg-zinc-700 py-2 rounded-lg justify-center space-x-2 text-xs">
      <ul>
        <li class="bg-gray-900 p-1 text-white rounded-md">
          <a target="_blank" rel="noopener noreferrer" title="twitter" aria-label="share Features on twitter"
            href="https://twitter.com/intent/tweet/?text=Features&amp;url=http://127.0.0.1:8000/fundamental-python-debugging-part-2-python-extensions.html">
            <i class="fab fa-twitter fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      </ul>
      <ul>
        <li class="bg-gray-900 p-1 text-white rounded-md">
          <a target="_blank" rel="noopener noreferrer" title="linkedin" aria-label="share Features on linkedin"
            href="https://www.linkedin.com/sharing/share-offsite/?url=http://127.0.0.1:8000/fundamental-python-debugging-part-2-python-extensions.html">
            <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      </ul>
      <ul>
        <li class="bg-gray-900 p-1 text-white rounded-md">
          <a target="_blank" rel="noopener noreferrer" title="reddit" aria-label="share Features on reddit"
            href="https://reddit.com/submit?url=http://127.0.0.1:8000/fundamental-python-debugging-part-2-python-extensions.html">
            <i class="fab fa-reddit fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      </ul>
      <ul>
        <li class="bg-gray-900 p-1 text-white rounded-md">
          <a target="_blank" rel="noopener noreferrer" title="facebook" aria-label="share Features on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http://127.0.0.1:8000/fundamental-python-debugging-part-2-python-extensions.html">
            <i class="fab fa-facebook fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      </ul>
      <ul>
        <li class="bg-gray-900 p-1 text-white rounded-md">
          <a target="_blank" rel="noopener noreferrer" title="whatsapp" aria-label="share Features on whatsapp"
            href="https://api.whatsapp.com/send?text=Features - http://127.0.0.1:8000/fundamental-python-debugging-part-2-python-extensions.html">
            <i class="fab fa-whatsapp fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      </ul>
      <ul>
        <li class="bg-gray-900 p-1 text-white rounded-md">
          <a target="_blank" rel="noopener noreferrer" title="telegram" aria-label="share Features on telegram"
            href="https://telegram.me/share/url?text=Features&amp;url=http://127.0.0.1:8000/fundamental-python-debugging-part-2-python-extensions.html">
            <i class="fab fa-telegram fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      </ul>
    </div>
  </footer>
  <div>
  </div>
</main>

    </div>
    <footer class="flex w-full text-xs justify-center mt-10 mb-6 text-zinc-600 dark:text-zinc-400">
        <div class="px-4">
            <span>©2022&nbsp;&#8226;&nbsp;</span>Powered by
            <a class="underline" href="https://getpelican.com/">Pelican</a>&nbsp;&
            <a class="underline" href="https://github.com/aleylara/Papyrus">Papyrus</a>
        </div>
    </footer>

<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-1FZ91XSPCR"></script>

    <script>
        let themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        let themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia(
                '(prefers-color-scheme: dark)').matches)) {
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            themeToggleDarkIcon.classList.remove('hidden');
        }
        let themeToggleBtn = document.getElementById('theme-toggle');
        themeToggleBtn.addEventListener('click', function () {
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');
            if (localStorage.getItem('color-theme')) {
                if (localStorage.getItem('color-theme') === 'light') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                }
            } else {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }
        });
    </script>
</body>

</html>